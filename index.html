<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nesta Signal Scout Pro</title>
    
    <script>
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.min.js" integrity="sha512-n/G+dROKbKL3GVngGWmWfwK0yPctjZQM752diVYnXZtD/48agpUKLIn0xDQL9ydZ91x6BiOmTIFwWjjFi2kEFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/10.0.2/standalone/umd/vis-network.min.js" integrity="sha512-9YVQZyV2hlSqEXZDwSEVia7u4T+qBkLE7KYG24LalL3J1zoQJXAiWpobprig/vGhV1VCfPIxF4EvHDYCSrSpmw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js" integrity="sha512-+EeCylkt9WHJk5tGJxYdecHOcXFRME7qnbsfeMsdQL6NUPYm2+uGFmyleEqsmVoap/f3dN/sc3BX9t9kHXkHHg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nesta: {
                            blue: '#0000FF',        
                            navy: '#0F294A',        
                            pink: '#F6A4B7',        
                            yellow: '#FDB633',      
                            green: '#18A48C',       
                            aqua: '#97D9E3',        
                            purple: '#9A1BBE',      
                            orange: '#FF6E47',      
                            red: '#EB003B',         
                            sand: '#D2C9C0',        
                            darkgrey: '#646363',    
                            black: '#000000',       
                            white: '#FFFFFF'        
                        }
                    },
                    fontFamily: {
                        display: ['"Zosia Display"', 'sans-serif'],
                        body: ['"Averta"', 'sans-serif']
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'radar-spin': 'spin 2s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        pop: {
                            '0%': { transform: 'scale(0.95)' },
                            '100%': { transform: 'scale(1)' }
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.6' }
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(15, 41, 74, 0.08)',
                        'hover': '0 10px 30px -5px rgba(0, 0, 255, 0.15)',
                        'glow': '0 0 15px rgba(151, 217, 227, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        /* FONTS */
        @font-face { font-family: 'Zosia Display'; src: url('Zosia-Display.woff2') format('woff2'); font-weight: bold; font-style: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Regular.otf') format('opentype'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Semibold.otf') format('opentype'); font-weight: bold; font-style: normal; }

        body { font-family: 'Averta', sans-serif; background-color: #F9FAFB; color: #0F294A; }
        h1, h2, h3, .brand-font { font-family: 'Zosia Display', sans-serif; }

        /* UTILITIES */
        .glass-panel { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(15, 41, 74, 0.05); }
        .card-hover { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 30px -8px rgba(0, 0, 255, 0.12); }
        
        /* HIGHLIGHT FOR RADAR CLICK */
        .card-highlight {
            border-color: #0000FF !important;
            box-shadow: 0 0 0 4px rgba(0, 0, 255, 0.2) !important;
            transform: scale(1.02);
        }
        
        /* CUSTOM RANGE SLIDER */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #0000FF; cursor: pointer; margin-top: -7px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #97D9E3; border-radius: 2px;
        }

        /* RADAR LOADER */
        .radar-loader {
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- BUTTON ANIMATIONS & INTERACTIVITY --- */
        
        /* Filter Chips (Purple) */
        .bias-chip label {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }
        .bias-chip label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(15, 41, 74, 0.1);
            border-color: #9A1BBE;
        }
        .bias-chip label:active { transform: scale(0.95); }
        .bias-chip input:checked + label {
            background-color: #9A1BBE; 
            color: #FFFFFF; 
            border-color: #9A1BBE; 
            box-shadow: 0 4px 12px rgba(154, 27, 190, 0.3);
            animation: pulse-purple 0.4s ease-out;
        }

        /* Hard Tech Toggle (Orange) */
        .tech-toggle-label { transition: all 0.2s ease; }
        .tech-toggle-group:hover .tech-toggle-label { color: #FF6E47; }
        .tech-toggle-group:active { transform: scale(0.98); }

        /* CTA Buttons */
        .btn-interactive { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-interactive:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn-interactive:active { transform: translateY(0); transform: scale(0.97); }

        /* Radar Filters */
        .filter-view-btn { transition: all 0.2s ease; }
        .filter-view-btn.active { background-color: #0F294A; color: white; border-color: #0F294A; }

        /* Fix Dropdown Arrows */
        select.appearance-none {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            background-color: transparent;
        }
        select::-ms-expand { display: none; }

        .tooltip {
            position: relative;
        }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: calc(100% + 8px);
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            font-family: 'Averta', sans-serif;
            font-size: 11px;
            line-height: 1.4;
            padding: 6px 10px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 50;
        }
        .tooltip:hover::after {
            opacity: 1;
        }

        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(154, 27, 190, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(154, 27, 190, 0); }
            100% { box-shadow: 0 0 0 0 rgba(154, 27, 190, 0); }
        }
        
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased bg-gray-50" onload="initDashboard()">

    <header class="bg-nesta-navy text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-nesta-navy flex items-center justify-center text-xl font-bold rounded-sm brand-font shadow-md">N</div>
                <div class="flex flex-col">
                    <h1 class="text-2xl leading-none tracking-tight">Signal Scout <span class="text-nesta-aqua">Pro</span></h1>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="openUserGuide()" class="btn-interactive px-4 py-2 text-sm font-bold text-nesta-navy bg-white border border-white/20 hover:bg-nesta-aqua hover:text-nesta-navy rounded-sm shadow-lg">
                    User Guide
                </button>
                <button onclick="downloadCSV()" class="btn-interactive px-4 py-2 text-sm font-bold text-white hover:text-nesta-aqua flex items-center gap-2 group border border-transparent hover:border-white/10 rounded">
                    <svg class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Export
                </button>
                <button onclick="generateBriefing()" class="btn-interactive px-4 py-2 text-sm font-bold text-white hover:text-nesta-aqua flex items-center gap-2 group border border-transparent hover:border-white/10 rounded">
                    üìÑ Briefing PDF
                </button>
                <button onclick="openSavedSignals()" class="btn-interactive px-6 py-2 bg-white text-nesta-navy text-sm font-bold rounded-sm hover:bg-nesta-aqua hover:text-nesta-navy shadow-lg">
                    Full Database
                </button>
            </div>
        </div>
        <div class="h-1.5 w-full bg-gradient-to-r from-nesta-blue via-nesta-purple to-nesta-orange"></div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-6 py-10 space-y-10">
        
        <div class="bg-white rounded-xl shadow-soft p-10 space-y-10 relative overflow-hidden border border-gray-100">
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                <div class="md:col-span-4 space-y-3">
                    <label for="mission-select" class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest pl-1">Nesta Mission</label>
                    <div class="relative group transition-all duration-300 ease-out hover:-translate-y-1 bg-white rounded-2xl">
                        <select id="mission-select" name="mission" class="w-full appearance-none bg-transparent border-2 border-gray-100 text-nesta-navy font-bold text-lg py-4 px-6 rounded-2xl focus:outline-none focus:border-nesta-blue focus:ring-4 focus:ring-nesta-blue/5 cursor-pointer hover:border-nesta-blue/30 transition-all duration-300 shadow-soft hover:shadow-hover z-10 relative">
                            <option class="text-nesta-navy" value="All Missions">All Missions</option>
                            <option class="text-nesta-navy" value="A Fairer Start">A Fairer Start üìö</option>
                            <option class="text-nesta-navy" value="A Healthy Life">A Healthy Life ‚ù§Ô∏è‚Äçü©π</option>
                            <option class="text-nesta-navy" value="A Sustainable Future">A Sustainable Future üå≥</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-6 pointer-events-none text-nesta-navy group-hover:text-nesta-blue transition-colors duration-300 z-0">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-8 space-y-3">
                    <label class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest pl-1">Scan Mode</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="tooltip flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-full text-xs font-bold text-nesta-navy bg-white shadow-sm cursor-pointer hover:border-nesta-blue/40 transition" data-tooltip="Mainstream tech journalism and industry reports.">
                            <input type="radio" name="scan_mode" value="general" class="text-nesta-blue focus:ring-nesta-blue" checked>
                            üì∞ News
                        </label>
                        <label class="tooltip flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-full text-xs font-bold text-nesta-navy bg-white shadow-sm cursor-pointer hover:border-nesta-blue/40 transition" data-tooltip="Policy trackers, government reports, and official releases.">
                            <input type="radio" name="scan_mode" value="policy" class="text-nesta-blue focus:ring-nesta-blue">
                            üèõÔ∏è Policy
                        </label>
                        <label class="tooltip flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-full text-xs font-bold text-nesta-navy bg-white shadow-sm cursor-pointer hover:border-nesta-blue/40 transition" data-tooltip="Grant programmes, funding calls, and research awards.">
                            <input type="radio" name="scan_mode" value="grants" class="text-nesta-blue focus:ring-nesta-blue">
                            üí∞ Grants
                        </label>
                        <label class="tooltip flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-full text-xs font-bold text-nesta-navy bg-white shadow-sm cursor-pointer hover:border-nesta-blue/40 transition" data-tooltip="Grassroots insights, forums, and community narratives.">
                            <input type="radio" name="scan_mode" value="community" class="text-nesta-blue focus:ring-nesta-blue">
                            üó£Ô∏è Community
                        </label>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 space-y-4">
                    <div class="space-y-2">
                        <label for="topic-input" class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Focus Topic (Optional)</label>
                        <div class="relative group transition-all duration-300 ease-out hover:-translate-y-1">
                            <input type="text" id="topic-input" name="topic"
                                class="w-full text-lg font-display text-nesta-navy placeholder-gray-300 border-2 border-gray-100 rounded-2xl py-5 px-6 shadow-soft focus:outline-none focus:border-nesta-blue focus:ring-4 focus:ring-nesta-blue/5 transition-all duration-300 bg-white hover:shadow-hover hover:border-nesta-blue/30 focus:scale-[1.01]"
                                placeholder="e.g. 'Generative AI' ‚Äî or leave empty for Broad Scan"
                                onkeypress="handleEnter(event)"
                                oninput="toggleButtonState()">
                            <button type="button" onclick="generateFrictionQuery()" title="Generate Friction Query"
                                class="absolute right-16 top-1/2 -translate-y-1/2 text-nesta-navy/70 hover:text-nesta-blue text-xl transition-transform duration-200 ease-out hover:scale-110">
                                üé≤
                            </button>
                            <div class="absolute right-6 top-1/2 -translate-y-1/2 text-nesta-blue transition-all duration-500 ease-out group-focus-within:scale-110 group-focus-within:rotate-12 group-focus-within:text-nesta-aqua">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-baseline px-1">
                            <label for="signal-count" class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Quantity</label>
                            <span id="count-display" class="text-xs font-bold text-nesta-navy bg-nesta-aqua/20 px-3 py-1 rounded-full">5 Signals</span>
                        </div>
                        <input type="range" id="signal-count" name="count" min="1" max="10" value="5" 
                               oninput="document.getElementById('count-display').innerText = this.value + ' Signals'"
                               class="w-full">
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-3">
                    <label class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">SOURCE FILTERS (Multi-Select)</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3" id="source-bias-container">
                        <div class="bias-chip relative">
                            <input type="checkbox" id="bias-policy" name="source_bias" value="Policy" class="peer sr-only">
                            <label for="bias-policy" class="tooltip px-4 py-3 border border-nesta-sand rounded-lg text-xs font-bold text-nesta-darkgrey cursor-pointer block" data-tooltip="Government portals, parliamentary sources, and policy documents.">üèõÔ∏è Gov & Policy Sites</label>
                        </div>
                        <div class="bias-chip relative">
                            <input type="checkbox" id="bias-grants" name="source_bias" value="Grants" class="peer sr-only">
                            <label for="bias-grants" class="px-4 py-3 border border-nesta-sand rounded-lg text-xs font-bold text-nesta-darkgrey cursor-pointer block">üí∞ Funding Bodies</label>
                        </div>
                        <div class="bias-chip relative">
                            <input type="checkbox" id="bias-academia" name="source_bias" value="Academia" class="peer sr-only">
                            <label for="bias-academia" class="tooltip px-4 py-3 border border-nesta-sand rounded-lg text-xs font-bold text-nesta-darkgrey cursor-pointer block" data-tooltip="Scientific papers, journals, and university research.">üß™ Academia</label>
                        </div>
                        <div class="bias-chip relative">
                            <input type="checkbox" id="bias-emerging" name="source_bias" value="Emerging Tech" class="peer sr-only">
                            <label for="bias-emerging" class="tooltip px-4 py-3 border border-nesta-sand rounded-lg text-xs font-bold text-nesta-darkgrey cursor-pointer block" data-tooltip="Broad landscape of innovation, including software, AI, and apps.">üöÄ Emerging Tech</label>
                        </div>
                        <div class="bias-chip relative">
                            <input type="checkbox" id="bias-data" name="source_bias" value="Open Data" class="peer sr-only">
                            <label for="bias-data" class="tooltip px-4 py-3 border border-nesta-sand rounded-lg text-xs font-bold text-nesta-darkgrey cursor-pointer block" data-tooltip="Open datasets, dashboards, and public data portals.">üìä Open Data</label>
                        </div>
                        <div class="bias-chip relative">
                            <input type="checkbox" id="bias-niche" name="source_bias" value="Niche Forums" class="peer sr-only">
                            <label for="bias-niche" class="tooltip px-4 py-3 border border-nesta-sand rounded-lg text-xs font-bold text-nesta-darkgrey cursor-pointer block" data-tooltip="Specialist forums and expert community spaces.">üó£Ô∏è Niche Forums</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 pt-2 border-t border-gray-100">
                <div class="flex flex-wrap gap-4">
                    <div class="tooltip flex items-center gap-3 bg-gray-50 px-5 py-3 border border-nesta-sand rounded-lg cursor-pointer hover:border-nesta-orange/50 transition shadow-sm tech-toggle-group" data-tooltip="Tangible engineering and scientific breakthroughs.">
                        <input type="checkbox" id="tech-mode" name="tech_mode" class="w-5 h-5 text-nesta-orange border-gray-300 rounded focus:ring-nesta-orange bg-white checked:bg-nesta-orange checked:border-transparent cursor-pointer">
                        <label for="tech-mode" class="text-sm font-bold text-nesta-navy cursor-pointer select-none tech-toggle-label">Deep Tech</label>
                    </div>

                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchView('list')" id="btn-list" class="px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md hover:scale-105 active:scale-95">List</button>
                        <button onclick="switchView('radar')" id="btn-radar" class="px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md hover:scale-105 active:scale-95">Radar</button>
                        <button onclick="switchView('network')" id="btn-network" class="px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md hover:scale-105 active:scale-95">Network</button>
                    </div>
                </div>

                <div class="flex flex-wrap gap-4 items-center">
                    <div class="bg-gray-50 border border-gray-200 rounded-full px-4 py-2 flex items-center gap-3">
                        <label for="time-filter" class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Time Horizon</label>
                        <div class="relative group">
                            <select id="time-filter" name="time_filter" class="appearance-none bg-transparent border-none focus:ring-0 cursor-pointer text-nesta-navy font-bold text-sm pr-6">
                                <option class="bg-white text-nesta-navy">Past Month</option>
                                <option class="bg-white text-nesta-navy">Past 3 Months</option>
                                <option class="bg-white text-nesta-navy">Past 6 Months</option>
                                <option class="bg-white text-nesta-navy">Past Year</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pointer-events-none text-nesta-navy group-hover:text-nesta-blue transition-colors">
                                 <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>

                    <div class="h-8 w-px bg-gray-200 mx-2 hidden lg:block"></div>
                    
                    <button onclick="generateSignal(true)" id="broad-btn" class="btn-interactive px-6 py-3 text-sm font-bold text-nesta-darkgrey hover:text-nesta-blue hover:bg-gray-50 rounded border border-transparent hover:border-nesta-blue/20">Broad Scan</button>
                    
                    <button id="search-btn" onclick="generateSignal(false)" class="hidden btn-interactive px-8 py-3 bg-nesta-blue text-white text-sm font-bold rounded shadow-lg hover:bg-blue-700 hover:shadow-xl flex items-center gap-3">
                        <span>Initiate Scan</span>
                    </button>
                    
                    <button id="stop-btn" onclick="stopScan()" class="hidden btn-interactive px-8 py-3 bg-nesta-red text-white text-sm font-bold rounded shadow-lg hover:bg-red-700 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        Stop
                    </button>

                    <button id="download-signals-btn" onclick="downloadSignalsAsCSV()" class="hidden btn-interactive px-6 py-3 text-sm font-bold bg-nesta-black text-white hover:bg-opacity-90 transition-all rounded-full">
                        Download CSV
                    </button>
                </div>
            </div>

            <div class="mt-6 border border-nesta-black rounded-lg overflow-hidden">
                <div id="terminal-header" onclick="toggleTerminal()" class="bg-nesta-black text-white p-2 flex justify-between items-center cursor-pointer text-xs font-bold uppercase tracking-widest">
                    <span class="text-nesta-green">&gt;_ SYSTEM LOGS</span>
                    <span id="terminal-toggle-indicator">[+]</span>
                </div>
                <div id="live-terminal" class="hidden bg-nesta-sand text-nesta-black text-xs font-body p-4 h-32 overflow-y-auto border-t border-nesta-black"></div>
            </div>
        </div>

        <div id="view-controls" class="flex justify-between items-center px-2">
            <div>
                <button onclick="synthesizeTrend()" class="btn-interactive px-5 py-2 text-xs font-bold bg-nesta-purple text-white rounded-full shadow-sm hover:bg-nesta-blue transition">
                    ‚ú® Synthesise
                </button>
            </div>
            <div class="flex gap-2 bg-white p-1.5 rounded-full shadow-sm border border-gray-100">
                <button onclick="switchFilter('scan')" id="filter-btn-scan" class="filter-view-btn active px-4 py-1.5 rounded-full text-xs font-bold border border-nesta-navy text-nesta-navy hover:bg-gray-100">Current Scan</button>
                <div class="h-6 w-px bg-gray-200 mx-1"></div>
                <button onclick="switchFilter('recent')" id="filter-btn-recent" class="filter-view-btn px-4 py-1.5 rounded-full text-xs font-bold border border-transparent text-gray-500 hover:bg-gray-50 hover:text-nesta-navy">Recent DB</button>
                <button onclick="switchFilter('funding')" id="filter-btn-funding" class="filter-view-btn px-4 py-1.5 rounded-full text-xs font-bold border border-transparent text-gray-500 hover:bg-gray-50 hover:text-nesta-navy">Funding</button>
                <button onclick="switchFilter('tech')" id="filter-btn-tech" class="filter-view-btn px-4 py-1.5 rounded-full text-xs font-bold border border-transparent text-gray-500 hover:bg-gray-50 hover:text-nesta-navy">Emerging Tech</button>
            </div>
        </div>

        <div id="result-container" class="grid grid-cols-1 gap-8"></div>
        
        <div id="radar-container" class="hidden bg-white p-10 shadow-soft border border-gray-100 min-h-[600px] flex flex-col items-center justify-center rounded-xl relative">
            <div class="w-full h-[500px] relative"><canvas id="signalRadar"></canvas></div>
        </div>

        <div id="network-container" class="hidden bg-white p-6 shadow-soft border border-gray-100 h-[600px] rounded-xl relative">
            <div id="signalNetwork" class="w-full h-full"></div>
        </div>

        <section id="preview-section" class="pt-12 border-t border-gray-200">
            <div class="flex justify-between items-end mb-8">
                <div>
                </div>
                <button onclick="openSavedSignals()" class="text-sm font-bold text-nesta-blue hover:text-nesta-navy transition flex items-center gap-1 group">
                    View All <span class="group-hover:translate-x-1 transition-transform">‚Üí</span>
                </button>
            </div>
            
            <div id="preview-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8 opacity-100">
                <div class="h-64 bg-white rounded-xl border border-gray-100 shadow-sm p-6 space-y-4 animate-pulse">
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-nesta-navy text-white mt-auto">
        <div class="h-1 w-full bg-gradient-to-r from-nesta-blue via-nesta-purple to-nesta-orange"></div>
        <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-6 h-6 bg-white text-nesta-navy flex items-center justify-center text-sm font-bold rounded-sm brand-font">N</div>
                <div class="flex flex-col">
                    <span class="text-sm font-display leading-none">Nesta Discovery Hub</span>
                </div>
            </div>
            <div class="text-[10px] font-body opacity-50 tracking-wide">
                &copy; 2025 NESTA. ALL RIGHTS RESERVED.
            </div>
        </div>
    </footer>

    <div id="saved-modal" class="fixed inset-0 bg-nesta-navy/90 backdrop-blur-md z-[100] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-7xl h-[85vh] shadow-2xl flex flex-col overflow-hidden rounded-2xl animate-fade-in-up">
            <div class="px-10 py-6 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h2 class="text-3xl brand-font text-nesta-navy">Signal Database</h2>
                </div>
                <button onclick="closeSavedSignals()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 transition rounded-full text-nesta-navy font-bold text-xl">‚úï</button>
            </div>
            <div id="saved-list" class="flex-1 overflow-y-auto p-10 bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>
    </div>

    <div id="user-guide-modal" class="fixed inset-0 bg-nesta-navy/90 backdrop-blur-md z-[110] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-4xl h-[85vh] shadow-2xl flex flex-col overflow-hidden rounded-2xl animate-fade-in-up font-body">
            <div class="px-10 py-6 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h2 class="text-3xl brand-font text-nesta-navy">Signal Scout: User Guide</h2>
                </div>
                <button onclick="closeUserGuide()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 transition rounded-full text-nesta-navy font-bold text-xl">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-10 space-y-12 text-nesta-navy font-body">
                
                <div class="text-center space-y-4 border-b border-gray-100 pb-10">
                    <div class="w-16 h-16 bg-nesta-blue text-white rounded-2xl flex items-center justify-center text-3xl font-bold mx-auto shadow-lg mb-4 brand-font">N</div>
                    <h3 class="text-4xl brand-font text-nesta-navy">Welcome to Signal Scout</h3>
                    <p class="text-lg max-w-2xl mx-auto text-gray-500">Your autonomous AI agent for discovering weak signals, emerging trends, and hidden innovations.</p>
                </div>

                <section>
                    <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-6 border-b border-gray-100 pb-2">How It Works</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="text-4xl mb-4">üîç</div>
                            <h5 class="font-bold text-nesta-navy text-lg mb-2">1. Scan</h5>
                            <p class="text-sm text-gray-600 leading-relaxed">The agent generates "High Entropy" queries (e.g. <em>"biotech + unregulated"</em>) to bypass mainstream news and find hidden gems.</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="text-4xl mb-4">üß†</div>
                            <h5 class="font-bold text-nesta-navy text-lg mb-2">2. Analyse</h5>
                            <p class="text-sm text-gray-600 leading-relaxed">It reads articles in real-time, verifying facts and scoring them on Novelty, Evidence, and Impact.</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="text-4xl mb-4">üíé</div>
                            <h5 class="font-bold text-nesta-navy text-lg mb-2">3. Synthesise</h5>
                            <p class="text-sm text-gray-600 leading-relaxed">It produces a concise "Signal Card" with a strategic hook, ready for your research database.</p>
                        </div>
                    </div>
                </section>

                <section>
                    <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-6 border-b border-gray-100 pb-2">Interface Guide</h4>
                    <div class="space-y-8">
                        
                        <div class="flex flex-col sm:flex-row items-start gap-6">
                            <div class="shrink-0 w-16 flex justify-center pt-2">
                                <span class="text-2xl shadow-sm border border-gray-200 rounded-lg p-2 bg-white">üé≤</span>
                            </div>
                            <div>
                                <h5 class="font-bold text-nesta-navy text-lg">The "Inspire Me" Button</h5>
                                <p class="text-sm text-gray-600 mt-1 max-w-xl">Stuck for ideas? Click the dice to instantly generate a <strong>"Friction Query"</strong>. This creates random collisions (e.g. <em>"heat pumps + lawsuit"</em>) that often lead to the most surprising discoveries.</p>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row items-start gap-6">
                            <div class="shrink-0 w-16 flex justify-center pt-2">
                                <div class="scale-75 origin-top">
                                    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 border border-nesta-sand rounded-lg shadow-sm w-max">
                                        <input type="checkbox" checked class="text-nesta-orange rounded focus:ring-0 cursor-default" onclick="return false;">
                                        <span class="text-xs font-bold text-nesta-navy">Deep Tech</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h5 class="font-bold text-nesta-navy text-lg">Deep Tech Mode</h5>
                                <p class="text-sm text-gray-600 mt-1 max-w-xl">Restricts results to <strong>"Atoms"</strong> (Hardware, Biotech, Energy, Materials). Use this when you want to filter out software apps and focus on tangible engineering breakthroughs.</p>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row items-start gap-6">
                            <div class="shrink-0 w-16 flex justify-center gap-1 pt-2">
                                <span class="w-2 h-2 rounded-full bg-nesta-red"></span>
                                <span class="w-2 h-2 rounded-full bg-nesta-blue"></span>
                                <span class="w-2 h-2 rounded-full bg-nesta-green"></span>
                            </div>
                            <div>
                                <h5 class="font-bold text-nesta-navy text-lg">Signal Actions</h5>
                                <ul class="text-sm text-gray-600 mt-2 space-y-1 list-disc pl-4">
                                    <li><strong>Reject:</strong> Discards the signal (helps train the filter).</li>
                                    <li><strong>Copy:</strong> Copies a formatted summary to your clipboard for Slack/Teams.</li>
                                    <li><strong>Star:</strong> Saves the signal to the "Shortlist" in the permanent database.</li>
                                </ul>
                            </div>
                        </div>

                    </div>
                </section>

                <section class="bg-nesta-navy text-white p-10 rounded-2xl shadow-soft">
                    <h4 class="text-xs font-bold uppercase tracking-widest text-nesta-aqua mb-8 border-b border-white/10 pb-4">The Scoring Framework</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center divide-y md:divide-y-0 md:divide-x divide-white/10">
                        <div class="pt-4 md:pt-0">
                            <div class="text-5xl font-bold brand-font text-nesta-yellow mb-3">0-10</div>
                            <div class="font-bold text-sm uppercase tracking-widest mb-3">Novelty</div>
                            <p class="text-sm opacity-70 px-4">"Distance from Mainstream"<br><br>High score = Obscure academic paper or niche forum.<br>Low score = BBC News or TechCrunch.</p>
                        </div>
                        <div class="pt-8 md:pt-0 md:pl-8">
                            <div class="text-5xl font-bold brand-font text-nesta-pink mb-3">0-10</div>
                            <div class="font-bold text-sm uppercase tracking-widest mb-3">Evidence</div>
                            <p class="text-sm opacity-70 px-4">"Reality Factor"<br><br>High score = A launched pilot, a passed law, or published data.<br>Low score = A "concept" or "vision".</p>
                        </div>
                        <div class="pt-8 md:pt-0 md:pl-8">
                            <div class="text-5xl font-bold brand-font text-nesta-aqua mb-3">0-10</div>
                            <div class="font-bold text-sm uppercase tracking-widest mb-3">Impact</div>
                            <p class="text-sm opacity-70 px-4">"The What!? Factor"<br><br>High score = Fundamentally changes a system or behaviour.<br>Low score = Incremental improvement.</p>
                        </div>
                    </div>
                </section>

            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-nesta-navy text-white px-6 py-4 shadow-2xl transform translate-y-24 opacity-0 transition-all duration-500 z-[120] font-bold text-sm flex items-center gap-4 rounded-lg border-l-4 border-nesta-aqua">
        <div class="w-2 h-2 rounded-full bg-nesta-aqua shrink-0"></div><span id="toast-msg">Action Successful</span>
    </div>

    <script src="friction-config.js"></script>
    <script>
        const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://127.0.0.1:8000' 
            : 'https://nesta-signal-backend.onrender.com';

        // --- GLOBAL STATE ---
        let currentSignals = []; // Displayed signals (Scan or DB View)
        let lastScanResults = []; // Cache for "Current Scan" view
        let currentSaved = []; // Full DB cache
        let activeFilter = 'scan'; // Track current filter
        
        let radarChart = null;
        let isProcessing = false;
        let scanController = null;
        let loadIntervals = [];
        let liveTerminalInterval = null;
        let liveTerminalIndex = 0;
        let networkChart = null;
        let currentSynth = null;

        const MISSION_EMOJIS = { 'A Fairer Start': 'üìö', 'A Healthy Life': '‚ù§Ô∏è‚Äçü©π', 'A Sustainable Future': 'üå≥' };
        const LENS_EMOJIS = { 'Social': 'üë•', 'Tech': 'ü§ñ', 'Media': 'üéôÔ∏è', 'Powerhouse': '‚ö°' };
        
        // Nesta Mission Colors for Radar
        const MISSION_COLORS = {
            'A Fairer Start': '#FDB633', // Yellow
            'A Healthy Life': '#F6A4B7', // Pink
            'A Sustainable Future': '#18A48C', // Green
            'Default': '#646363' // Dark Grey for Mission Adjacent/Others
        };

        // --- IMPROVED BACKEND WARMUP LOGIC FOR RENDER COLD STARTS ---
        async function warmBackend() {
            // Helper function for a single check
            const check = async () => {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000); // 3s timeout for each ping
                try {
                    const res = await fetch(`${API_BASE_URL}/`, { method: 'GET', cache: 'no-store', signal: controller.signal });
                    return res.ok;
                } catch (e) {
                    console.error('Backend check failed:', e);
                    return false;
                } finally {
                    clearTimeout(timeout);
                }
            };

            // 1. Try once immediately. If it's already warm, we are done.
            if (await check()) return true;

            // 2. If first check fails, backend is sleeping. Start Polling Loop.
            // Render free tier can take 30-90 seconds to wake up.
            showToast('Waking up Scout Agent... (This may take 60s)', 'normal');
            
            const start = Date.now();
            const MAX_WAIT_MS = 90000; // 90 seconds max wait
            let attempt = 0;

            while (Date.now() - start < MAX_WAIT_MS) {
                attempt++;
                await new Promise(r => setTimeout(r, 4000)); // Wait 4s between checks
                
                if (await check()) {
                    showToast('Agent Online!', 'success');
                    return true;
                }

                // Update user every 3rd failed attempt (approx 12s) to keep them engaged
                if (attempt % 3 === 0) {
                     showToast('Still waking up... please wait', 'normal');
                }
            }
            
            showToast('Connection failed. Please refresh.', 'error');
            return false;
        }

        async function initDashboard() {
            // Load the UI skeleton first so the page isn't blank
            toggleButtonState(); 
            switchFilter('scan');

            // Now perform the robust connection check
            const ready = await warmBackend();
            
            if (!ready) {
                // If we failed after 90s, show error in preview area
                document.getElementById('preview-grid').innerHTML = '<div class="text-center py-10 text-nesta-red font-bold">Backend Offline. Please refresh page.</div>';
                return;
            }
            
            // Backend is ready, safe to fetch data
            loadPreview();
        }

        function toggleButtonState() {
            if (isProcessing) return;
            const input = document.getElementById('topic-input');
            const broadBtn = document.getElementById('broad-btn');
            const searchBtn = document.getElementById('search-btn');
            const hasText = input.value.trim().length > 0;

            if (hasText) {
                broadBtn.classList.add('hidden');
                searchBtn.classList.remove('hidden');
            } else {
                broadBtn.classList.remove('hidden');
                searchBtn.classList.add('hidden');
            }
        }

        function generateFrictionQuery() {
            const topics = [
                // --- A SUSTAINABLE FUTURE ---
                "biomass boiler", "decarbonised housing", "low carbon built environment", "carbon capture storage",
                "climate tech", "green tech", "net zero material", "district heating", "heat network",
                "energy efficiency retrofit", "building insulation", "smart meter", "smart thermostat",
                "demand response", "electricity grid flexibility", "energy storage batteries", "geothermal heat",
                "green skills", "heat pumps", "heat batteries", "thermal energy storage", "blue hydrogen",
                "green hydrogen", "hydrogen boiler", "micro-chp", "photovoltaic", "solar thermal",
                "wind turbine", "community energy", "retrofitting",

                // --- A FAIRER START ---
                "school readiness", "executive function", "speech therapy", "childcare affordability",
                "nursery shortage", "early years curriculum", "montessori", "forest schools",
                "cognitive development", "language acquisition", "phonics", "numeracy", "gamified learning",
                "learning through play", "edtech", "parental leave", "work-life balance", "peer support groups",
                "classroom technology", "early years analytics", "motor skills development", "adhd diagnosis",
                "autism support", "dyslexia tools", "special educational needs", "infant sleep patterns",
                "maternal health", "fetal development", "family income support", "financial inclusion for parents",

                // --- A HEALTHY LIFE ---
                "ultra processed food", "precision fermentation", "glp-1", "semaglutide", "ozempic",
                "digital therapeutics", "gut microbiome", "personalized nutrition", "nutrigenomics",
                "sugar reduction", "salt reduction", "fat replacers", "plant-based protein", "lab-grown meat",
                "cellular agriculture", "mycoprotein", "insect protein", "vertical farming", "food environment",
                "dark kitchens", "ultra fast delivery", "robot chefs", "kitchen automation", "smart appliances",
                "food waste reduction", "upcycled food", "reformulation", "clean label", "functional food",
                "medical foods", "lifestyle medicine", "social prescribing", "mental health apps",
                "wearable health trackers", "remote patient monitoring", "telehealth", "online pharmacy",
                "metabolic health", "type 2 diabetes prevention", "obesity stigma", "food marketing regulation",
                "active travel", "micromobility", "e-bikes", "e-scooters", "walkable cities",

                // --- CROSS-CUTTING & TECH ---
                "generative ai", "synthetic biology", "quantum sensing", "privacy enhancing tech",
                "autonomous robotics", "computer vision", "natural language processing", "deepfakes",
                "algorithmic bias", "digital literacy", "online safety", "screen time impact",
                "virtual reality", "augmented reality", "immersive education", "social media influence",
                "data privacy", "cybersecurity", "blockchain", "web3", "metaverse", "5g connectivity",
                "internet of things", "smart cities", "digital inclusion", "tech ethics"
            ];
            const modifiers = window.FRICTION_MODIFIERS || [];
            if (!topics.length || !modifiers.length) {
                console.warn("Friction query lists are missing.");
                return;
            }
            const topic = topics[Math.floor(Math.random() * topics.length)];
            const modifier = modifiers[Math.floor(Math.random() * modifiers.length)];
            const input = document.getElementById('topic-input');
            input.value = `${topic} + "${modifier}"`;
            toggleButtonState();
        }

        // --- LOADING ANIMATION LOGIC ---
        function startLoadingSimulation(requestedCount) {
            const statuses = [
                "Initialising Scout Agent...", "Scanning Global Sources...", "Filtering Mainstream Noise...",
                "Applying Friction Method...", "Scoring Novelty & Evidence...", "Synthesising Intelligence..."
            ];
            let statusIndex = 0;
            stopLoadingSimulation(); 

            // Base duration roughly 25s for 1 signal, scaling up non-linearly
            // e.g., 5 signals might take 45s, 10 signals ~70s
            // This is just a simulation, but gives feedback based on request size.
            const SIMULATION_BASE_FACTOR = 250;
            const DEFAULT_REQUEST_COUNT = 5;
            const COUNT_MULTIPLIER = 40;

            const baseFactor = SIMULATION_BASE_FACTOR;
            const countFactor = (requestedCount || DEFAULT_REQUEST_COUNT) * COUNT_MULTIPLIER;
            const speed = baseFactor + countFactor;

            const statInt = setInterval(() => {
                statusIndex = (statusIndex + 1) % statuses.length;
                const el = document.getElementById('loading-status-text');
                if(el) {
                    el.style.opacity = '0';
                    setTimeout(() => { el.innerText = statuses[statusIndex]; el.style.opacity = '1'; }, 200);
                }
            }, 3500);
            loadIntervals.push(statInt);

            let progress = 0;
            const progInt = setInterval(() => {
                if(progress < 99) {
                    let increment = (100 - progress) / speed;
                    if(increment < 0.05) increment = 0.05; 
                    progress += increment;
                    const textEl = document.getElementById('loading-percent-text');
                    const barEl = document.getElementById('loading-bar-inner');
                    if(textEl) textEl.innerText = Math.floor(progress) + '%';
                    if(barEl) barEl.style.width = progress + '%';
                }
            }, 100);
            loadIntervals.push(progInt);
        }

        function stopLoadingSimulation() {
            loadIntervals.forEach(clearInterval);
            loadIntervals = [];
        }

        function addTerminalLine(text) {
            const terminal = document.getElementById('live-terminal');
            if (!terminal) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const line = document.createElement('div');
            line.textContent = `> [${time}] ${text}`;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function startLiveTerminal() {
            const terminal = document.getElementById('live-terminal');
            if (terminal) {
                terminal.innerHTML = '<div class="opacity-70">&gt; Waiting for scan...</div>';
            }
            const messages = [
                'Initialising scout agent...',
                'Searching for relevant sources...',
                'Verifying deep links...',
                'Scraping signal context...',
                'Scoring novelty and evidence...',
                'Synthesising candidate signals...'
            ];
            liveTerminalIndex = 0;
            addTerminalLine(messages[liveTerminalIndex]);
            if (liveTerminalInterval) {
                clearInterval(liveTerminalInterval);
            }
            liveTerminalInterval = setInterval(() => {
                liveTerminalIndex = (liveTerminalIndex + 1) % messages.length;
                addTerminalLine(messages[liveTerminalIndex]);
            }, 4000);
        }

        function stopLiveTerminal() {
            if (liveTerminalInterval) {
                clearInterval(liveTerminalInterval);
                liveTerminalInterval = null;
            }
            addTerminalLine('Scan complete.');
        }

        function downloadSignalsAsCSV() {
            const signals = currentSignals.length > 0 ? currentSignals : lastScanResults;
            if (!signals || signals.length === 0) {
                showToast('No signals to download', 'error');
                return;
            }
            const headers = ['Title', 'URL', 'Hook', 'Novelty Score', 'Evidence Score', 'Mission'];
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const stringValue = String(value).replace(/"/g, '""');
                return `"${stringValue}"`;
            };
            const rows = signals.map((signal) => [
                escapeCSV(signal.title),
                escapeCSV(signal.final_url || signal.url),
                escapeCSV(signal.hook),
                escapeCSV(signal.score_novelty),
                escapeCSV(signal.score_evidence),
                escapeCSV(signal.mission)
            ]);
            const csv = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            const mode = getSelectedScanMode();
            const modeLabel = mode ? mode.charAt(0).toUpperCase() + mode.slice(1) : 'General';
            const dateString = new Date().toISOString().split('T')[0];
            const filename = `SignalScout_${modeLabel}_${dateString}.csv`;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function getMissionEmoji(mission) {
            for (const [key, emoji] of Object.entries(MISSION_EMOJIS)) { if (mission.includes(key)) return emoji; }
            return ''; 
        }

        function getMissionColor(mission) {
            if (!mission) return MISSION_COLORS['Default'];
            for (const [key, color] of Object.entries(MISSION_COLORS)) {
                if (mission.includes(key)) return color;
            }
            return MISSION_COLORS['Default'];
        }

        function formatSource(url) {
            try {
                const hostname = new URL(url).hostname.replace('www.', '');
                const name = hostname.split('.')[0];
                return name.length <= 3 ? name.toUpperCase() : name.charAt(0).toUpperCase() + name.slice(1);
            } catch { return 'Source'; }
        }

        function cleanText(text) {
            if (!text) return "";
            let clean = text.replace(/^In \d{4},?\s*/i, "");
            clean = clean.replace(/\[[^\]]*\]/g, "");
            clean = clean.replace(/\\/g, "");
            return clean;
        }

        function getLensBadges(lensesStr, styleClass) {
            if (!lensesStr) return '';
            const style = styleClass || "bg-gray-50 text-nesta-darkgrey border-gray-200"; 
            const tags = lensesStr.split(',').map(t => t.trim());
            let html = '<div class="flex flex-wrap gap-2 mb-4">';
            tags.forEach(tag => {
                let emoji = '';
                for (const [key, icon] of Object.entries(LENS_EMOJIS)) {
                    if (tag.toLowerCase().includes(key.toLowerCase())) emoji = icon;
                }
                if (emoji) {
                    html += `<span class="px-2 py-1 border rounded text-[10px] font-bold ${style}" title="${tag}">${emoji} ${tag}</span>`;
                }
            });
            html += '</div>';
            return html;
        }

        // --- DATA MANAGEMENT ---
        async function ensureDatabaseLoaded() {
            if (currentSaved.length === 0) {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/saved`);
                    if(!res.ok) throw new Error();
                    currentSaved = (await res.json()).reverse(); // Newest first
                } catch(e) { console.error("DB Load Error", e); }
            }
        }

        async function loadPreview() {
            const grid = document.getElementById('preview-grid');
            try {
                await ensureDatabaseLoaded();
                const data = currentSaved;
                if(!data || data.length === 0) { grid.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-400">Database empty.</div>'; return; }
                
                const recent = data.slice(0, 3);
                
                grid.innerHTML = ''; 
                recent.forEach((sig, i) => {
                    const normalized = normalizeSignal(sig);
                    createSignalCard(normalized, i, false, 'preview-grid');
                });
            } catch(e) { grid.innerHTML = '<div class="col-span-3 text-center text-xs text-red-400 py-10">Database Offline</div>'; }
        }

        function normalizeSignal(sig) {
            return {
                title: sig.Title || sig.title, 
                score: sig.Score || sig.score, 
                hook: sig.Hook || sig.hook, 
                final_url: sig.URL || sig.final_url || sig.url,
                mission: sig.Mission || sig.mission, 
                lenses: sig.Lenses || sig.lenses, 
                score_novelty: sig.Score_Novelty || sig.score_novelty, 
                score_evidence: sig.Score_Evidence || sig.score_evidence, 
                score_evocativeness: sig.Score_Evocativeness || sig.score_evocativeness,
                shareable: sig.Shareable || sig.shareable, 
                feedback: sig.Feedback || sig.User_Comment || sig.feedback,
                _row: sig._row, 
                source_date: sig.Source_Date || sig.source_date
            };
        }

        function renderDatabase() {
            const list = document.getElementById('saved-list');
            if (!list) return;
            list.innerHTML = '';
            if (!currentSaved || currentSaved.length === 0) {
                list.innerHTML = '<div class="col-span-full text-center py-20 text-gray-400">Database is empty.</div>';
                return;
            }
            currentSaved.forEach((sig, i) => {
                const normalized = normalizeSignal(sig);
                createSignalCard(normalized, i, true, 'saved-list');
            });
        }

        // --- UNIFIED FILTER LOGIC ---
        async function switchFilter(type) {
            activeFilter = type;
            
            // UI Toggle
            document.querySelectorAll('.filter-view-btn').forEach(b => {
                b.classList.remove('active', 'bg-nesta-navy', 'text-white', 'border-nesta-navy');
                b.classList.add('text-gray-500', 'border-transparent');
            });
            const btn = document.getElementById(`filter-btn-${type}`);
            if(btn) {
                btn.classList.add('active', 'bg-nesta-navy', 'text-white', 'border-nesta-navy');
                btn.classList.remove('text-gray-500', 'border-transparent');
            }

            // Data Logic
            const listContainer = document.getElementById('result-container');
            
            if (type === 'scan') {
                if (lastScanResults.length === 0) {
                    currentSignals = [];
                    listContainer.innerHTML = `<div class="col-span-full py-16 text-center border-2 border-dashed border-gray-200 rounded-xl"><p class="text-nesta-darkgrey font-bold">No active scan results.</p><p class="text-xs text-gray-400 mt-1">Enter a topic above to initiate a scan.</p></div>`;
                    renderRadar(); // Clears radar
                    updateDownloadButton();
                    return;
                }
                currentSignals = lastScanResults;
            } else {
                await ensureDatabaseLoaded();
                if (currentSaved.length === 0) {
                    listContainer.innerHTML = `<div class="text-center py-10">Database offline or empty.</div>`;
                    return;
                }
                
                let filtered = [];
                if (type === 'recent') {
                    filtered = currentSaved.slice(0, 10);
                } else if (type === 'funding') {
                    const keywords = ['fund', 'invest', 'venture', 'capital', 'raise', 'grant', 'million', 'billion', 'round'];
                    filtered = currentSaved.filter(s => {
                        const txt = ((s.Title||'') + (s.Hook||'') + (s.User_Comment||'')).toLowerCase();
                        return keywords.some(k => txt.includes(k));
                    });
                } else if (type === 'tech') {
                    filtered = currentSaved.filter(s => {
                        const lenses = (s.Lenses || '').toLowerCase();
                        const hook = (s.Hook || '').toLowerCase();
                        return lenses.includes('tech') || hook.includes('ai') || hook.includes('quantum') || hook.includes('novel');
                    });
                }
                currentSignals = filtered.map(normalizeSignal);
            }
            
            // Re-render both views
            renderList(); 
            renderRadar();
        }

        function renderList() {
            const container = document.getElementById('result-container');
            container.innerHTML = '';
            currentSignals.forEach((sig, i) => createSignalCard(sig, i));
            updateDownloadButton();
        }

        function showToast(msg, type='success') {
            const el = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const dot = el.querySelector('div');
            
            // Allow 'normal' type for neutral/blue notifications that aren't errors
            let colorClass, borderClass;
            switch (type) {
                case 'error':
                    colorClass = 'bg-nesta-red';
                    borderClass = 'border-nesta-red';
                    break;
                case 'success':
                    colorClass = 'bg-nesta-green';
                    borderClass = 'border-nesta-green';
                    break;
                default: // 'normal' and other types
                    colorClass = 'bg-nesta-aqua';
                    borderClass = 'border-nesta-aqua';
            }
            
            dot.className = `w-2 h-2 rounded-full ${colorClass}`;
            el.className = `fixed bottom-8 right-8 bg-nesta-navy text-white px-6 py-4 shadow-2xl transform transition-all duration-500 z-[120] font-bold text-sm flex items-center gap-4 rounded-lg border-l-4 ${borderClass}`;
            el.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => el.classList.add('translate-y-24', 'opacity-0'), 3000);
        }

        function handleEnter(e) { if(e.key === 'Enter') generateSignal(false); }
        function getCheckedSources() { return Array.from(document.querySelectorAll('#source-bias-container input:checked')).map(cb => cb.value); }
        function getSelectedScanMode() {
            const selected = document.querySelector('input[name="scan_mode"]:checked');
            return selected ? selected.value : 'general';
        }
        function updateDownloadButton() {
            const button = document.getElementById('download-signals-btn');
            if (!button) return;
            if (lastScanResults.length > 0) {
                button.classList.remove('hidden');
            } else {
                button.classList.add('hidden');
            }
        }

        function switchView(view) {
            const list = document.getElementById('result-container');
            const radar = document.getElementById('radar-container');
            const network = document.getElementById('network-container');
            const btnList = document.getElementById('btn-list');
            const btnRadar = document.getElementById('btn-radar');
            const btnNetwork = document.getElementById('btn-network');
            
            if(view === 'list') {
                list.classList.remove('hidden');
                radar.classList.add('hidden');
                network.classList.add('hidden');
                btnList.className = "px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md";
                btnRadar.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
                btnNetwork.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
            } else if (view === 'radar') {
                list.classList.add('hidden');
                radar.classList.remove('hidden');
                network.classList.add('hidden');
                btnRadar.className = "px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md";
                btnList.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
                btnNetwork.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
                renderRadar();
            } else {
                list.classList.add('hidden');
                radar.classList.add('hidden');
                network.classList.remove('hidden');
                btnNetwork.className = "px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md";
                btnList.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
                btnRadar.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
                renderNetwork();
            }
        }

        function renderNetwork() {
            const container = document.getElementById('signalNetwork');
            if (!container) return;
            if (!currentSignals.length) {
                container.innerHTML = '<div class="text-center text-gray-400 font-bold py-10">No signals to visualise.</div>';
                return;
            }

            const nodes = new vis.DataSet(
                currentSignals.map((signal, index) => ({
                    id: index,
                    label: signal.title || `Signal ${index + 1}`,
                    title: signal.hook || '',
                }))
            );

            const edges = [];
            const sanitize = (text) =>
                (text || '')
                    .toLowerCase()
                    .replace(/[^a-z0-9\s]/g, ' ')
                    .split(/\s+/) 

            for (let i = 0; i < currentSignals.length; i++) {
                const signalA = currentSignals[i];
                const wordsA = new Set(sanitize(signalA.title));
                for (let j = i + 1; j < currentSignals.length; j++) {
                    const signalB = currentSignals[j];
                    const wordsB = sanitize(signalB.title);
                    const sharedWord = wordsB.find((word) => wordsA.has(word));
                    const shareMission = signalA.mission && signalB.mission && signalA.mission === signalB.mission;
                    if (shareMission || sharedWord) {
                        edges.push({ from: i, to: j });
                    }
                }
            }

            const data = { nodes, edges };
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 14,
                    color: {
                        background: '#0F294A',
                        border: '#0F294A',
                        highlight: {
                            background: '#F6A4B7',
                            border: '#F6A4B7',
                        },
                    },
                    font: { color: '#0F294A', size: 12 },
                },
                edges: {
                    color: { color: '#D1D5DB' },
                    width: 1,
                    smooth: true,
                },
                interaction: {
                    hover: true,
                },
                physics: {
                    stabilization: true,
                },
            };

            if (networkChart) {
                networkChart.destroy();
            }
            networkChart = new vis.Network(container, data, options);
        }

        async function synthesizeTrend() {
            if (!currentSignals.length) {
                showToast('No signals to synthesise.', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_BASE_URL}/api/synthesize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signals: currentSignals }),
                });
                if (!res.ok) throw new Error();
                const data = await res.json();
                currentSynth = data;

                const container = document.getElementById('result-container');
                if (!container) return;
                const existing = document.getElementById('synth-card');
                if (existing) existing.remove();

                const card = document.createElement('div');
                card.id = 'synth-card';
                card.className = 'bg-gradient-to-r from-nesta-purple to-nesta-blue text-white rounded-xl p-8 shadow-soft';
                card.innerHTML = `
                    <div class="text-xs uppercase tracking-widest text-white/70 mb-3">Meta-Analysis</div>
                    <h3 class="text-3xl font-bold brand-font mb-3">${data.trend_name || 'Emerging Trend'}</h3>
                    <p class="text-sm leading-relaxed mb-4">${data.analysis || ''}</p>
                    <div class="text-sm font-semibold">Implication: <span class="font-normal">${data.implication || ''}</span></div>
                `;
                container.prepend(card);
            } catch (error) {
                showToast('Synthesis failed. Please retry.', 'error');
            }
        }

        function generateBriefing() {
            if (!currentSignals.length) {
                showToast('No signals to export.', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const now = new Date();
            const dateLabel = now.toLocaleDateString('en-GB');
            const filenameDate = now.toISOString().split('T')[0];

            let y = 16;
            doc.setFontSize(14);
            doc.text('Nesta Signal Scout // Intelligence Briefing', 14, y);
            y += 8;
            doc.setFontSize(10);
            doc.text(`Date: ${dateLabel}`, 14, y);
            y += 10;

            if (currentSynth) {
                doc.setFontSize(12);
                doc.text('Executive Summary', 14, y);
                y += 6;
                doc.setFontSize(10);
                const summary = `${currentSynth.trend_name || ''} ‚Äî ${currentSynth.analysis || ''} ${currentSynth.implication || ''}`.trim();
                const summaryLines = doc.splitTextToSize(summary, 180);
                doc.text(summaryLines, 14, y);
                y += summaryLines.length * 5 + 4;
            }

            doc.setFontSize(12);
            doc.text('Signals', 14, y);
            y += 6;
            doc.setFontSize(10);

            currentSignals.slice(0, 6).forEach((signal) => {
                const block = `${signal.title || 'Untitled'} (Score: ${signal.score || '-'})\n${signal.hook || ''}`;
                const lines = doc.splitTextToSize(block, 180);
                if (y + lines.length * 5 > 280) {
                    doc.addPage();
                    y = 16;
                }
                doc.text(lines, 14, y);
                y += lines.length * 5 + 6;
            });

            doc.save(`Nesta_Briefing_${filenameDate}.pdf`);
        }

        function setScanningState(isScanning) {
            const startBtn = document.getElementById('search-btn');
            const broadBtn = document.getElementById('broad-btn');
            const stopBtn = document.getElementById('stop-btn');

            if (isScanning) {
                startBtn.classList.add('hidden');
                broadBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
            } else {
                stopBtn.classList.add('hidden');
                toggleButtonState();
            }
        }

        function toggleTerminal() {
            const terminal = document.getElementById('live-terminal');
            const indicator = document.getElementById('terminal-toggle-indicator');
            if (!terminal || !indicator) return;
            terminal.classList.toggle('hidden');
            indicator.textContent = terminal.classList.contains('hidden') ? '[+]' : '[-]';
        }

        function stopScan() {
            if (scanController) {
                scanController.abort();
                scanController = null;
                showToast('Scan Cancelled', 'error');
            }
        }

        async function generateSignal(isBroad) {
            if (isProcessing) return;
            const topic = document.getElementById('topic-input').value;
            const container = document.getElementById('result-container');
            const signalCount = parseInt(document.getElementById('signal-count').value) || 5;
            const requestTimeoutMs = 120000;
            
            if (!topic && !isBroad) return showToast("Please enter a topic", "error");

            isProcessing = true;
            setScanningState(true); 
            switchView('list');
            // Force filter to 'scan' mode
            switchFilter('scan'); 
            updateDownloadButton();
            startLiveTerminal();
            
            container.innerHTML = `
                <div class="col-span-full py-24 flex flex-col items-center justify-center space-y-8 animate-fade-in-up">
                    <div class="radar-loader w-16 h-16 border-4 border-t-nesta-blue"></div>
                    <div class="w-full max-w-md space-y-2">
                        <div class="flex justify-between items-end px-1">
                            <p id="loading-status-text" class="font-display text-xl text-nesta-navy transition-opacity duration-200">Initialising Scout Agent...</p>
                            <p id="loading-percent-text" class="font-bold text-nesta-blue text-xl">0%</p>
                        </div>
                        <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                            <div id="loading-bar-inner" class="h-full bg-gradient-to-r from-nesta-blue to-nesta-aqua w-0 transition-all duration-100 ease-out"></div>
                        </div>
                        <p class="text-[10px] font-bold text-nesta-darkgrey uppercase tracking-widest text-center pt-2">AI Analysis in Progress</p>
                    </div>
                </div>`;
            
            startLoadingSimulation(signalCount);

            const missionSelectValue = document.getElementById('mission-select').value;

            const payload = {
                message: isBroad 
                    ? `Find ${signalCount} high-novelty novel signals related to ${missionSelectValue}. Context: ${topic}` 
                    : `Find ${signalCount} signals about ${topic} for ${missionSelectValue}`,
                time_filter: document.getElementById('time-filter').value,
                source_types: getCheckedSources(),
                tech_mode: document.getElementById('tech-mode').checked,
                mission: missionSelectValue,
                signal_count: signalCount,
                scan_mode: getSelectedScanMode()
            };

            scanController = new AbortController();
            const signal = scanController.signal;

            let timeoutId;
            try {
                // We reuse the robust check here too, in case user went idle
                const backendReady = await warmBackend();
                if (!backendReady) {
                    stopLoadingSimulation();
                    container.innerHTML = `<div class="p-8 bg-white border-l-4 border-nesta-red shadow-sm text-center"><p class="font-bold text-nesta-red">Backend Offline</p><p class="text-sm text-gray-500">Could not reach the scanning service. Trying again in a moment...</p></div>`;
                    showToast('Could not reach backend. Please retry.', 'error');
                    return;
                }

                timeoutId = setTimeout(() => {
                    if (scanController) {
                        scanController.abort();
                    }
                }, requestTimeoutMs);

                const res = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                    signal: signal 
                });

                if(!res.ok) throw new Error();

                currentSignals = [];
                lastScanResults = [];

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const msg = JSON.parse(line);
                            if (msg.type === 'progress') {
                                document.getElementById('loading-status-text').innerText = msg.message;
                            } else if (msg.type === 'signal') {
                                const norm = normalizeSignal(msg.data);
                                currentSignals.push(norm);
                                createSignalCard(norm, currentSignals.length - 1);
                                lastScanResults = currentSignals;
                                updateDownloadButton();
                            } else if (msg.type === 'error') {
                                showToast(msg.message, 'error');
                            }
                        } catch (e) { console.error('Stream parse error', e); }
                    }
                }
                stopLoadingSimulation();
                const loader = document.querySelector('.radar-loader');
                if (loader) loader.parentElement.remove();
                // Signals already streamed in; avoid clearing the container.
            } catch (error) {
                stopLoadingSimulation();
                if (error.name === 'AbortError') {
                    container.innerHTML = `<div class="p-10 text-center text-gray-400">Scan cancelled.</div>`;
                } else {
                    container.innerHTML = `<div class="p-8 bg-white border-l-4 border-nesta-red shadow-sm text-center"><p class="font-bold text-nesta-red">Connection Failed</p><p class="text-sm text-gray-500">Please check your internet or try again later.</p></div>`;
                }
            } finally {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                isProcessing = false;
                scanController = null;
                setScanningState(false);
                stopLiveTerminal();
            }
        }

        function createSignalCard(signal, index, showActions = true, containerId = 'result-container') {
            const container = document.getElementById(containerId);
            const m = (signal.mission || "").toLowerCase();
            let isDarkCard = true;
            
            // --- STYLING CONFIGURATION ---
            let styles = {
                cardBg: "bg-nesta-darkgrey",
                barColor: "bg-nesta-darkgrey", 
                badge: "bg-white text-nesta-navy", 
                title: "text-white hover:text-nesta-aqua",
                desc: "text-white", 
                accentLabel: "text-white", 
                scoreVal: "text-white",
                gridBg: "bg-white/5 border-white/10", 
                lens: "bg-white/10 text-white border-white/20",
                footer: "text-gray-300",
                inputBg: "bg-white/10 text-white border-white/20 placeholder-gray-400 focus:border-nesta-aqua",
                selectBg: "bg-nesta-navy text-white border-white/20",
                button: "bg-nesta-aqua text-nesta-navy hover:bg-white"
            };

            function colorCardOverrides(bgColor) {
                return {
                    cardBg: bgColor,
                    barColor: bgColor, 
                    badge: "bg-white text-nesta-navy", 
                    title: "text-nesta-navy hover:text-white",
                    desc: "text-nesta-navy", 
                    accentLabel: "text-nesta-navy", 
                    scoreVal: "text-nesta-navy",
                    gridBg: "bg-white/20 border-white/20", 
                    lens: "bg-white/40 text-nesta-navy border-white/20",
                    footer: "text-nesta-navy/70",
                    inputBg: "bg-white/40 text-nesta-navy border-white/30 placeholder-nesta-navy/50 focus:border-nesta-navy",
                    selectBg: "bg-white/40 text-nesta-navy border-white/30",
                    button: "bg-nesta-navy text-white hover:bg-white hover:text-nesta-navy"
                };
            }

            if (m.includes("fairer")) { styles = { ...styles, ...colorCardOverrides("bg-nesta-yellow") }; }
            else if (m.includes("sustainable")) { styles = { ...styles, ...colorCardOverrides("bg-nesta-green") }; }
            else if (m.includes("healthy")) { styles = { ...styles, ...colorCardOverrides("bg-nesta-pink") }; }

            if (m.includes("fairer") || m.includes("healthy")) {
                isDarkCard = false;
            }
            const actionBtnStyle = isDarkCard
                ? "bg-white text-nesta-navy hover:bg-gray-100"
                : "bg-nesta-navy text-white hover:bg-opacity-90";
            styles.actionBtn = `${actionBtnStyle} px-3 py-2 rounded-full transition text-xs font-bold`;

            const missionEmoji = getMissionEmoji(signal.mission || '');
            const sourceName = formatSource(signal.final_url || signal.url);
            const lensTags = getLensBadges(signal.lenses || '', styles.lens);
            const cleanHook = cleanText(signal.hook);
            const accentClass = `text-[9px] uppercase font-bold mb-1 tracking-wider ${styles.accentLabel}`;

            const card = document.createElement('div');
            card.id = `${containerId}-card-${index}`;
            const linkStatusId = `${containerId}-link-status-${index}`;
            card.className = `${styles.cardBg} p-7 border border-black/5 flex flex-col h-full shadow-soft rounded-xl animate-fade-in-up transition-all duration-300 transform hover:-translate-y-1`;

            const actionBar = `
                <div class="mt-4 flex items-center justify-between gap-3">
                    <button type="button" onclick="rejectSignal('${signal.final_url || signal.url}', '${card.id}')" class="${styles.actionBtn}" title="Reject">
                        üëé Reject
                    </button>
                    <button type="button" id="copy-slack-${card.id}" class="${styles.actionBtn}">
                        üìã Copy
                    </button>
                    <button type="button" id="keep-btn-${card.id}" onclick="keepSignal('${signal.final_url || signal.url}', 'keep-btn-${card.id}')" class="${styles.actionBtn}" title="Star">
                        ‚≠ê Star
                    </button>
                </div>
            `;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-5">
                    <span class="px-3 py-1 rounded-sm text-[10px] font-bold uppercase tracking-widest ${styles.badge}">
                        ${missionEmoji} ${signal.mission || 'General'}
                    </span>
                    <span class="flex items-center justify-center w-8 h-8 bg-nesta-black text-white font-bold text-sm rounded-full shadow-md">
                        ${signal.score || '-'}
                    </span>
                </div>
                
                <h3 class="text-2xl brand-font mb-3 leading-tight transition-colors ${styles.title}">
                    <a href="${signal.final_url || signal.url}" target="_blank" class="hover:underline decoration-2 underline-offset-4 decoration-current opacity-90 hover:opacity-100">${signal.title}</a>
                </h3>
                
                ${lensTags}

                <p class="text-sm mb-6 leading-relaxed flex-grow font-body ${styles.desc}">${cleanHook}</p>
                
                <div class="grid grid-cols-3 gap-2 py-4 border-t border-b mb-5 rounded-sm ${styles.gridBg}">
                     <div class="text-center">
                        <div class="${accentClass}">Novelty</div>
                        <div class="font-bold text-lg ${styles.scoreVal}">${signal.score_novelty}/10</div>
                     </div>
                     <div class="text-center border-l border-black/5">
                        <div class="${accentClass}">Evidence</div>
                        <div class="font-bold text-lg ${styles.scoreVal}">${signal.score_evidence}/10</div>
                     </div>
                     <div class="text-center border-l border-black/5">
                        <div class="${accentClass}">Impact</div>
                        <div class="font-bold text-lg ${styles.scoreVal}">${signal.score_evocativeness}/10</div>
                     </div>
                </div>
                
                <div class="flex items-center justify-between text-xs font-bold mt-auto ${styles.footer}">
                    <span>${signal.source_date || 'Recent'}</span>
                    <a href="${signal.final_url || signal.url}" target="_blank" class="flex items-center gap-2 hover:opacity-100 opacity-70 transition group">
                        <span id="${linkStatusId}" class="w-2 h-2 rounded-full bg-nesta-sand" title="Checking link..."></span>
                        ${sourceName} <span class="text-lg leading-none group-hover:translate-x-0.5 transition-transform">‚Üó</span>
                    </a>
                </div>

                ${showActions ? actionBar : ''}
            `;
            container.appendChild(card);
            const linkUrl = signal.final_url || signal.url;
            if (linkUrl) {
                checkLinkHealth(linkUrl, linkStatusId);
            }
            const copyButton = document.getElementById(`copy-slack-${card.id}`);
            if (copyButton) {
                copyButton.dataset.title = signal.title || '';
                copyButton.dataset.hook = cleanHook || '';
                copyButton.dataset.url = linkUrl || '';
                copyButton.addEventListener('click', (event) => {
                    const { title, hook, url } = event.currentTarget.dataset;
                    shortlistSignal({ title, hook, url });
                });
            }
        }

        async function updateSignalStatus(url, status) {
            if (!url) return;
            try {
                await fetch(`${API_BASE_URL}/api/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url, user_status: status })
                });
            } catch (e) {
                console.error('Status update failed', e);
            }
        }

        async function rejectSignal(url, cardId) {
            await updateSignalStatus(url, 'Rejected');
            const card = document.getElementById(cardId);
            if (card) {
                card.remove();
            }
            currentSignals = currentSignals.filter(signal => (signal.final_url || signal.url) !== url);
            lastScanResults = lastScanResults.filter(signal => (signal.final_url || signal.url) !== url);
            const normalizeUrl = (value) => {
                if (!value) return '';
                try {
                    return decodeURIComponent(String(value)).trim().toLowerCase();
                } catch (e) {
                    return String(value).trim().toLowerCase();
                }
            };
            const targetUrl = normalizeUrl(url);
            currentSaved = currentSaved.filter(signal => normalizeUrl(signal.URL || signal.url) !== targetUrl); // Ensure case-insensitive comparison for consistency.
            updateDownloadButton();
            showToast('Signal rejected', 'normal');
        }

        async function shortlistSignal(cardData) {
            copyForSlack(cardData);
            await updateSignalStatus(cardData?.url, 'Shortlisted');
        }

        async function keepSignal(url, buttonId) {
            await updateSignalStatus(url, 'Saved');
            const button = document.getElementById(buttonId);
            if (button) {
                button.textContent = '‚≠ê Starred';
                button.classList.add('bg-nesta-sand');
            }
            showToast('Signal starred', 'success');
        }

        async function checkLinkHealth(url, indicatorId) {
            const indicator = document.getElementById(indicatorId);
            if (!indicator) return;
            indicator.className = 'w-2 h-2 rounded-full bg-nesta-sand';
            indicator.title = 'Checking link...';
            try {
                await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                indicator.className = 'w-2 h-2 rounded-full bg-nesta-green';
                indicator.title = 'Server responded (link validity not checked)';
            } catch (e) {
                indicator.className = 'w-2 h-2 rounded-full bg-nesta-red';
                indicator.title = 'Server unreachable (link may be broken)';
            }
        }

        async function copyForSlack(cardData) {
            const title = cardData?.title || 'Untitled Signal';
            const hook = cardData?.hook || '';
            const url = cardData?.url || '';
            const text = `*${title}*\n> ${hook}\nSource: ${url}`;
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied!', 'success');
            } catch (e) {
                showToast('Clipboard unavailable', 'error');
            }
        }

        async function openSavedSignals() {
            document.getElementById('saved-modal').classList.remove('hidden');
            const list = document.getElementById('saved-list');
            list.innerHTML = '<div class="col-span-full py-24 text-center flex flex-col items-center"><div class="radar-loader mb-4 border-2 border-gray-200 border-t-nesta-blue w-10 h-10"></div><p class="font-bold text-nesta-navy">Retrieving Intelligence...</p></div>';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/saved`);
                const data = await res.json();
                list.innerHTML = '';
                // NEWEST FIRST for full database view as well
                currentSaved = data.reverse(); 
                renderDatabase();
            } catch(e) { list.innerHTML = '<div class="col-span-full text-center text-nesta-red py-10 font-bold">Failed to load database.</div>'; }
        }

        function closeSavedSignals() { document.getElementById('saved-modal').classList.add('hidden'); }

        function openUserGuide() { document.getElementById('user-guide-modal').classList.remove('hidden'); }
        function closeUserGuide() { document.getElementById('user-guide-modal').classList.add('hidden'); }

        async function updateSavedSignal(url, title, domIndex) {
            const shareVal = document.getElementById(`saved-shareable-${domIndex}`).value;
            const commentVal = document.getElementById(`saved-comment-${domIndex}`)?.value || '';
            const statusMap = { Yes: 'Shortlisted', Maybe: 'Saved', No: 'Rejected' };
            const userStatus = statusMap[shareVal] || 'Saved';
            try {
                const res = await fetch(`${API_BASE_URL}/api/update`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url, title, shareable: shareVal, user_status: userStatus, user_comment: commentVal, feedback: commentVal })
                });
                if(res.ok) { showToast('Database updated'); currentSaved = []; loadPreview(); }
                else throw new Error();
            } catch(e) { showToast('Update failed', 'error'); }
        }

        function downloadCSV() {
            if(!currentSaved || currentSaved.length === 0) return showToast('No data to export', 'error');
            let csv = "Title,URL,Score,Mission,Hook,Date,Status,Notes\n";
            currentSaved.forEach(r => { csv += `"${r.Title}","${r.URL}",${r.Score},"${r.Mission}","${(r.Hook||"").replace(/"/g, '""')}",${r.Source_Date},${r.Shareable},"${r.User_Comment||""}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Signal_Export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // --- INTERACTIVE RADAR ---
        function scrollToCard(index) {
            switchView('list'); 
            const cardId = `result-container-card-${index}`;
            const card = document.getElementById(cardId);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.classList.add('card-highlight');
                setTimeout(() => card.classList.remove('card-highlight'), 2000);
            }
        }

        function renderRadar() {
            const canvas = document.getElementById('signalRadar');
            if (radarChart) radarChart.destroy();

            // 1. Prepare Data
            const dataPoints = currentSignals.map((s, i) => ({
                x: s.score_novelty || Math.random() * 10,
                y: s.score_evidence || Math.random() * 10,
                r: (s.score / 6) + 5,
                title: s.title,
                mission: s.mission,
                hook: s.hook,
                index: i
            }));

            // 2. Define Quadrant Background Plugin
            const quadrantPlugin = {
                id: 'quadrants',
                beforeDraw(chart) {
                    const { ctx, chartArea: { left, top, right, bottom }, scales: { x, y } } = chart;
                    const midX = x.getPixelForValue(5);
                    const midY = y.getPixelForValue(5);

                    const drawZone = (x1, y1, x2, y2, color, label) => {
                        ctx.fillStyle = color;
                        ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
                        ctx.fillStyle = 'rgba(15, 41, 74, 0.1)';
                        ctx.font = 'bold 12px "Zosia Display"';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        const labelX = x1 + (x2 - x1) / 2;
                        const labelY = y1 + (y2 - y1) / 2;
                        ctx.fillText(label, labelX, labelY);
                    };

                    drawZone(left, top, midX, midY, 'rgba(240, 240, 240, 0.3)', 'ESTABLISHED TRENDS');
                    drawZone(midX, top, right, midY, 'rgba(151, 217, 227, 0.1)', 'GOLDEN SIGNALS (Act Now)');
                    drawZone(left, midY, midX, bottom, 'rgba(235, 0, 59, 0.03)', 'EARLY NOISE');
                    drawZone(midX, midY, right, bottom, 'rgba(253, 182, 51, 0.1)', 'WILDCARDS (Watch)');

                    ctx.strokeStyle = '#0F294A';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(midX, top); ctx.lineTo(midX, bottom);
                    ctx.moveTo(left, midY); ctx.lineTo(right, midY);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            };

            // 3. Render Chart
            radarChart = new Chart(canvas, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Signals',
                        data: dataPoints,
                        backgroundColor: dataPoints.map(p => getMissionColor(p.mission)),
                        borderColor: '#fff',
                        borderWidth: 2,
                        hoverBackgroundColor: '#0F294A',
                        hoverBorderColor: '#0F294A',
                        hoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 20 },
                    scales: {
                        x: {
                            type: 'linear',
                            min: 0, max: 10,
                            title: { display: true, text: 'NOVELTY (How new is it?)', color: '#0F294A', font: { weight: 'bold' } },
                            grid: { display: false }
                        },
                        y: {
                            type: 'linear',
                            min: 0, max: 10,
                            title: { display: true, text: 'EVIDENCE (How real is it?)', color: '#0F294A', font: { weight: 'bold' } },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(15, 41, 74, 0.95)',
                            titleFont: { family: 'Zosia Display', size: 14 },
                            bodyFont: { family: 'Averta', size: 12 },
                            padding: 12,
                            cornerRadius: 4,
                            callbacks: {
                                label: (ctx) => {
                                    const p = ctx.raw;
                                    return [p.title, `Novelty: ${p.x.toFixed(1)} | Evidence: ${p.y.toFixed(1)}`];
                                }
                            }
                        },
                        legend: { display: false }
                    },
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const idx = activeElements[0].index;
                            const point = dataPoints[idx];
                            scrollToCard(point.index);
                        }
                    }
                },
                plugins: [quadrantPlugin]
            });
        }
    </script>
</body>
</html>
