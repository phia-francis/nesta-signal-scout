<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nesta Signal Scout Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --nesta-purple: #9A1BBE;
            --nesta-green: #18A48C;
            --nesta-aqua: #97D9E3;
            --nesta-navy: #0F294A;
            --nesta-black: #000000;
            --nesta-white: #FFFFFF;
        }

        body { 
            font-family: 'Century Gothic', CenturyGothic, AppleGothic, sans-serif;
            background-color: var(--nesta-white);
            color: var(--nesta-black);
        }

        .nesta-checkbox {
            appearance: none; width: 16px; height: 16px;
            border: 2px solid var(--nesta-black); cursor: pointer;
            display: inline-block; vertical-align: middle; margin-right: 6px;
        }
        .nesta-checkbox:checked { background-color: var(--nesta-green); }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--nesta-navy); }
        ::-webkit-scrollbar-thumb:hover { background: var(--nesta-purple); }
        
        .range-slider { -webkit-appearance: none; background: transparent; }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px; height: 24px; background: var(--nesta-purple); 
            cursor: pointer; border: none; margin-top: -10px;
        }
        .range-slider::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #ddd; border: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .border-nesta { border: 3px solid var(--nesta-black); }
    </style>
</head>
<body class="h-screen overflow-hidden selection:bg-[#97D9E3] selection:text-black">

    <div class="flex h-full max-w-[1400px] mx-auto p-6 gap-6">
        
        <div class="flex-1 flex flex-col gap-6">
            <div class="bg-white border-nesta p-8 relative">
                <div class="absolute top-0 left-0 w-full h-3 bg-[#97D9E3]"></div>

                <div class="flex justify-between items-end mb-6 border-b-2 border-black pb-4 mt-2">
                    <h2 class="font-bold text-4xl tracking-tight text-black leading-none">
                        <span class="text-[#9A1BBE]">nesta</span><br>Signal Scout
                    </h2>
                    <span class="bg-[#0F294A] text-white px-3 py-1 text-xs font-bold uppercase tracking-widest">Discovery Hub</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                    <div>
                        <div class="flex justify-between mb-4 items-center">
                            <label class="text-sm font-bold uppercase tracking-widest text-[#0F294A]">Signal Volume</label>
                            <span id="slider-val" class="text-2xl font-bold text-[#9A1BBE]">3</span>
                        </div>
                        <input type="range" id="signal-count" min="1" max="10" value="3" 
                            class="range-slider w-full focus:outline-none"
                            oninput="document.getElementById('slider-val').innerText = this.value">
                        <div class="flex justify-between text-xs font-bold mt-2 text-gray-400"><span>1</span><span>10</span></div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold uppercase tracking-widest text-[#0F294A] mb-2">Strategic Mission</label>
                        <div class="relative">
                            <select id="mission-select" class="w-full bg-white border-2 border-black text-black font-bold text-sm focus:outline-none focus:border-[#9A1BBE] block p-3 appearance-none cursor-pointer rounded-none hover:bg-[#97D9E3] transition-colors">
                                <option value="All Missions">‚ú® Auto: All Missions</option>
                                <option value="A Fairer Start">üìö A Fairer Start</option>
                                <option value="A Healthy Life">‚ù§Ô∏è‚Äçü©π A Healthy Life</option>
                                <option value="A Sustainable Future">üå≥ A Sustainable Future</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 border-2 border-black p-4 mb-6 text-sm">
                    <div class="flex flex-wrap gap-6 items-center">
                        <div class="flex flex-col gap-1">
                            <label class="font-bold text-[10px] uppercase text-[#0F294A] tracking-wider">Time Horizon</label>
                            <select id="time-filter" class="bg-white border border-black px-2 py-1 text-xs font-bold cursor-pointer hover:bg-[#97D9E3]">
                                <option value="Past Year">Past Year</option>
                                <option value="Past 6 Months">Past 6 Months</option>
                                <option value="Past 3 Months">Past 3 Months</option>
                                <option value="Past Month">Past Month</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-2 border-l border-gray-300 pl-6">
                            <input type="checkbox" id="tech-mode" class="nesta-checkbox">
                            <label for="tech-mode" class="font-bold text-xs uppercase cursor-pointer select-none hover:text-[#9A1BBE]">Emerging Tech Only</label>
                        </div>

                        <div class="flex gap-4 border-l border-gray-300 pl-6 flex-1">
                            <label class="flex items-center gap-1 cursor-pointer hover:text-[#18A48C]"><input type="checkbox" name="source" value="Academia" class="nesta-checkbox"><span class="text-[10px] font-bold uppercase">Academia</span></label>
                            <label class="flex items-center gap-1 cursor-pointer hover:text-[#18A48C]"><input type="checkbox" name="source" value="Industry News" class="nesta-checkbox"><span class="text-[10px] font-bold uppercase">Industry News</span></label>
                            <label class="flex items-center gap-1 cursor-pointer hover:text-[#18A48C]"><input type="checkbox" name="source" value="Startups" class="nesta-checkbox"><span class="text-[10px] font-bold uppercase">Startups/VC</span></label>
                            <label class="flex items-center gap-1 cursor-pointer hover:text-[#18A48C]"><input type="checkbox" name="source" value="Substacks" class="nesta-checkbox"><span class="text-[10px] font-bold uppercase">Substacks</span></label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-0 border-nesta">
                    <input type="text" id="manual-input" placeholder="Topic (e.g., 'Generative AI')" class="flex-1 bg-white px-5 py-4 text-base font-bold placeholder:font-normal placeholder:text-gray-400 focus:outline-none focus:bg-[#f0f9fa] border-none rounded-none text-black">
                    <button onclick="runScan()" class="bg-[#9A1BBE] text-white hover:bg-[#0F294A] px-10 py-4 font-bold uppercase tracking-wider transition-colors rounded-none whitespace-nowrap">Launch Scan</button>
                </div>
            </div>

            <div id="chat-box" class="flex-1 bg-[#f9fafb] border-nesta p-8 overflow-y-auto space-y-8 relative scroll-smooth">
                <div class="flex flex-col items-center justify-center h-full text-gray-300 select-none">
                    <p class="text-7xl mb-4 grayscale opacity-20">üì°</p>
                    <p class="font-bold text-sm text-[#0F294A] tracking-widest uppercase">Ready to Scout</p>
                </div>
            </div>
        </div>

        <div class="w-80 md:w-96 bg-white border-nesta flex flex-col overflow-hidden h-full z-10">
            <div class="bg-[#0F294A] text-white p-5 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold uppercase tracking-wider flex items-center gap-2 text-sm">üíæ Signal Vault</h3>
                    <button onclick="refreshDatabase()" class="text-[10px] font-bold uppercase hover:text-[#97D9E3] transition-colors border border-white px-2 py-1">Refresh</button>
                </div>
                <a id="sheet-link" href="#" target="_blank" class="text-[10px] text-[#97D9E3] hover:text-white underline text-right truncate">View Full Sheet ‚Üó</a>
            </div>
            
            <div id="db-list" class="flex-1 overflow-y-auto p-5 space-y-4 bg-white">
                <div class="flex flex-col items-center justify-center h-40 text-gray-400"><span class="text-xs uppercase font-bold tracking-widest">Vault Empty</span></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://nesta-signal-backend.onrender.com"; 
        let currentSignals = [];

        window.onload = async () => {
            // Get Sheet URL on load
            try {
                const cfg = await fetch(`${API_BASE}/api/config`).then(r => r.json());
                if(cfg.sheet_url) document.getElementById('sheet-link').href = cfg.sheet_url;
            } catch(e) {}
            refreshDatabase();
        };

        async function runScan() {
            const chatBox = document.getElementById('chat-box');
            const topic = document.getElementById('manual-input').value.trim();
            const count = document.getElementById('signal-count').value;
            const mission = document.getElementById('mission-select').value;
            const timeFilter = document.getElementById('time-filter').value;
            const techMode = document.getElementById('tech-mode').checked;
            const sources = Array.from(document.querySelectorAll('input[name="source"]:checked')).map(cb => cb.value);

            if(chatBox.innerText.includes("Ready to Scout")) chatBox.innerHTML = "";

            let prompt = `Find ${count} distinct innovation signals`;
            if (topic) prompt += ` related to '${topic}'`;
            else prompt += ` (perform a broad horizon scan)`;
            
            prompt += ". Use the display_signal_card tool for each one.";

            chatBox.innerHTML += `
                <div class="flex justify-end animate-fade-in mb-8">
                    <div class="bg-[#0F294A] text-white p-6 border-l-8 border-[#97D9E3] max-w-[80%]">
                        <div class="font-bold text-xs text-[#97D9E3] mb-3 uppercase tracking-widest border-b border-gray-600 pb-2">Scan Parameters</div>
                        <div class="space-y-1 text-sm font-medium">
                            <div class="flex justify-between"><span class="opacity-70">TARGET:</span> <span>${count} Signals</span></div>
                            <div class="flex justify-between"><span class="opacity-70">MISSION:</span> <span>${mission}</span></div>
                            ${techMode ? `<div class="flex justify-between text-[#18A48C]"><span class="opacity-70">MODE:</span> <span>Emerging Tech Only</span></div>` : ''}
                            ${sources.length ? `<div class="flex justify-between"><span class="opacity-70">SOURCES:</span> <span class="text-xs">${sources.join(', ')}</span></div>` : ''}
                            <div class="flex justify-between"><span class="opacity-70">TIMELINE:</span> <span>${timeFilter}</span></div>
                        </div>
                    </div>
                </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            const loaderId = `load-${Date.now()}`;
            chatBox.innerHTML += `<div id="${loaderId}" class="flex gap-4 items-center text-[#9A1BBE] text-sm ml-2 mt-4 font-bold uppercase animate-pulse"><div class="w-4 h-4 bg-[#9A1BBE]"></div> Scouting horizon...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const res = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: prompt,
                        time_filter: timeFilter,
                        source_types: sources,
                        tech_mode: techMode
                    })
                });
                
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                const data = await res.json();
                document.getElementById(loaderId).remove();

                if (data.ui_type === 'signal_list') {
                    data.items.forEach(signal => renderCard(signal));
                    renderSystemMessage(`SCAN COMPLETE. ${data.items.length} SIGNALS IDENTIFIED.`);
                } else if (data.ui_type === 'signal_card') {
                    renderCard(data);
                } else {
                    renderSystemMessage(data.content);
                }

            } catch (err) {
                console.error(err);
                const loader = document.getElementById(loaderId);
                if(loader) loader.innerHTML = `<div class="bg-[#EB003B] text-white p-4 font-bold">‚ö†Ô∏è ERROR: ${err.message}</div>`;
            }
        }

        function renderSystemMessage(html) {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML += `<div class="flex animate-fade-in mb-6"><div class="bg-[#D2C9C0] p-4 text-sm font-bold text-black max-w-[90%] uppercase tracking-wide border-l-4 border-black">${html}</div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function renderCard(data) {
            currentSignals.push(data);
            const idx = currentSignals.length - 1;
            const chatBox = document.getElementById('chat-box');
            
            let scoreClass = "bg-gray-100 text-black";
            if(data.score >= 80) scoreClass = "bg-[#18A48C] text-white"; 
            else if(data.score >= 60) scoreClass = "bg-[#97D9E3] text-black";

            const missionHtml = data.mission ? `<span class="bg-[#0F294A] text-white text-[10px] px-2 py-1 font-bold uppercase tracking-widest">${data.mission}</span>` : '';
            const lensesHtml = data.lenses ? data.lenses.split(',').map(tag => `<span class="border border-black text-black text-[10px] px-2 py-1 font-bold uppercase hover:bg-[#97D9E3] transition-colors">${tag.trim()}</span>`).join('') : '';

            const sEvo = data.score_evocativeness || 0;
            const sNov = data.score_novelty || 0;
            const sEvi = data.score_evidence || 0;

            const cardHTML = `
                <div class="animate-fade-in group mb-8">
                    <div class="bg-white border-2 border-black p-8 relative hover:border-[#9A1BBE] transition-colors">
                        <div class="flex justify-between items-start mb-5 border-b border-gray-200 pb-4">
                            <span class="text-[#9A1BBE] font-bold text-xs uppercase tracking-widest">${data.archetype || 'SIGNAL'}</span>
                            <div class="relative group/score cursor-help">
                                <div class="font-mono text-sm font-bold ${scoreClass} px-3 py-1">‚ö° ${data.score}/100</div>
                                <div class="absolute bottom-full right-0 mb-2 w-48 bg-[#0F294A] text-white p-3 text-[10px] uppercase font-bold tracking-widest hidden group-hover/score:block border-2 border-[#97D9E3] z-50 shadow-lg">
                                    <div class="flex justify-between mb-1"><span class="text-[#97D9E3]">Evocative</span> <span>${sEvo}/10</span></div>
                                    <div class="flex justify-between mb-1"><span class="text-[#97D9E3]">Novelty</span> <span>${sNov}/10</span></div>
                                    <div class="flex justify-between"><span class="text-[#97D9E3]">Evidence</span> <span>${sEvi}/10</span></div>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-bold text-black text-2xl leading-tight mb-4 group-hover:text-[#9A1BBE] transition-colors">${data.title}</h3>
                        <p class="text-sm text-gray-800 mb-6 leading-relaxed font-medium">${data.hook}</p>
                        <div class="flex flex-wrap gap-2 mb-8">${missionHtml}${lensesHtml}</div>
                        <div class="grid grid-cols-2 gap-0 border-2 border-black">
                            <button onclick="saveSignalByIndex(${idx}, this)" class="bg-black text-white text-xs font-bold py-4 hover:bg-[#9A1BBE] transition-colors uppercase tracking-widest border-r border-gray-700">Save Signal</button>
                            <a href="${data.final_url}" target="_blank" class="bg-white text-black text-xs font-bold py-4 text-center uppercase tracking-widest hover:bg-[#97D9E3] transition-colors">Source ‚Üó</a>
                        </div>
                    </div>
                </div>`;
            chatBox.innerHTML += cardHTML;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function saveSignalByIndex(idx, btn) {
            const data = currentSignals[idx];
            const originalContent = btn.innerHTML;
            btn.innerHTML = `SAVING...`;
            try {
                const res = await fetch(`${API_BASE}/api/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: data.title,
                        score: data.score,
                        archetype: data.archetype,
                        hook: data.hook,
                        url: data.final_url,
                        mission: data.mission || "",
                        lenses: data.lenses || "",
                        score_evocativeness: data.score_evocativeness || 0,
                        score_novelty: data.score_novelty || 0,
                        score_evidence: data.score_evidence || 0
                    })
                });
                if(res.ok) {
                    btn.className = "bg-[#18A48C] text-white text-xs font-bold py-4 cursor-default uppercase tracking-widest border-r border-gray-700";
                    btn.innerHTML = `SAVED`;
                    btn.removeAttribute("onclick");
                    refreshDatabase();
                } else { throw new Error("Save failed"); }
            } catch (err) {
                alert("Failed to save.");
                btn.innerHTML = originalContent;
            }
        }

        async function refreshDatabase() {
            const list = document.getElementById('db-list');
            try {
                const res = await fetch(`${API_BASE}/api/saved`);
                const items = await res.json();
                if(items.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-400"><span class="text-xs uppercase font-bold tracking-widest">Vault Empty</span></div>`;
                    return;
                }
                // Mapping Google Sheet Rows (Keys match row order)
                list.innerHTML = items.map(item => `
                    <div class="bg-white p-4 border border-black relative group hover:border-[#9A1BBE] transition-colors animate-fade-in">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest truncate max-w-[60%]">${item['Archetype'] || item['archetype'] || 'SIGNAL'}</span>
                            <span class="text-[10px] font-bold text-white bg-[#9A1BBE] px-1">${item['Score'] || item['score'] || 0}</span>
                        </div>
                        <div class="font-bold text-black text-xs leading-snug pr-6 mb-2">
                            <a href="${item['URL'] || item['url']}" target="_blank" class="hover:text-[#18A48C] transition-colors line-clamp-2">${item['Title'] || item['title']}</a>
                        </div>
                    </div>`).join('');
            } catch (err) { console.error("DB Error", err); }
        }
    </script>
</body>
</html>
