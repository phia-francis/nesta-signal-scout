<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nesta Signal Scout Pro</title>
    
    <script>
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nesta: {
                            blue: '#0000FF',       
                            navy: '#0F294A',       
                            pink: '#F6A4B7',       
                            yellow: '#FDB633',     
                            green: '#18A48C',      
                            aqua: '#97D9E3',       
                            purple: '#9A1BBE',     
                            orange: '#FF6E47',     
                            red: '#EB003B',        
                            sand: '#D2C9C0',       
                            darkgrey: '#646363',   
                            black: '#000000',      
                            white: '#FFFFFF'       
                        }
                    },
                    fontFamily: {
                        display: ['"Zosia Display"', 'sans-serif'],
                        body: ['"Averta"', 'sans-serif']
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'radar-spin': 'spin 2s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        pop: {
                            '0%': { transform: 'scale(0.95)' },
                            '100%': { transform: 'scale(1)' }
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.6' }
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(15, 41, 74, 0.08)',
                        'hover': '0 10px 30px -5px rgba(0, 0, 255, 0.15)',
                        'glow': '0 0 15px rgba(151, 217, 227, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        /* FONTS */
        @font-face { font-family: 'Zosia Display'; src: url('Zosia-Display.woff2') format('woff2'); font-weight: bold; font-style: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Regular.otf') format('opentype'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Semibold.otf') format('opentype'); font-weight: bold; font-style: normal; }

        body { font-family: 'Averta', sans-serif; background-color: #F9FAFB; color: #0F294A; }
        h1, h2, h3, .brand-font { font-family: 'Zosia Display', sans-serif; }

        /* UTILITIES */
        .glass-panel { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(15, 41, 74, 0.05); }
        .card-hover { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 30px -8px rgba(0, 0, 255, 0.12); }
        
        /* HIGHLIGHT FOR RADAR CLICK */
        .card-highlight {
            border-color: #0000FF !important;
            box-shadow: 0 0 0 4px rgba(0, 0, 255, 0.2) !important;
            transform: scale(1.02);
        }
        
        /* CUSTOM RANGE SLIDER */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #0000FF; cursor: pointer; margin-top: -7px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #97D9E3; border-radius: 2px;
        }

        /* RADAR LOADER */
        .radar-loader {
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- BUTTON ANIMATIONS & INTERACTIVITY --- */
        
        /* Filter Chips (Purple) */
        .bias-chip label {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }
        .bias-chip label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(15, 41, 74, 0.1);
            border-color: #9A1BBE;
        }
        .bias-chip label:active { transform: scale(0.95); }
        .bias-chip input:checked + label {
            background-color: #9A1BBE; 
            color: #FFFFFF; 
            border-color: #9A1BBE; 
            box-shadow: 0 4px 12px rgba(154, 27, 190, 0.3);
            animation: pulse-purple 0.4s ease-out;
        }

        /* Hard Tech Toggle (Orange) */
        .tech-toggle-label { transition: all 0.2s ease; }
        .tech-toggle-group:hover .tech-toggle-label { color: #FF6E47; }
        .tech-toggle-group:active { transform: scale(0.98); }

        /* CTA Buttons */
        .btn-interactive { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-interactive:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn-interactive:active { transform: translateY(0); transform: scale(0.97); }

        /* Radar Filters */
        .filter-view-btn { transition: all 0.2s ease; }
        .filter-view-btn.active { background-color: #0F294A; color: white; border-color: #0F294A; }

        /* Fix Dropdown Arrows */
        select.appearance-none {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            background-color: transparent;
        }
        select::-ms-expand { display: none; }

        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(154, 27, 190, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(154, 27, 190, 0); }
            100% { box-shadow: 0 0 0 0 rgba(154, 27, 190, 0); }
        }
        
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased bg-gray-50" onload="initDashboard()">

    <header class="bg-nesta-navy text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-nesta-navy flex items-center justify-center text-xl font-bold rounded-sm brand-font shadow-md">N</div>
                <div class="flex flex-col">
                    <h1 class="text-2xl leading-none tracking-tight">Signal Scout <span class="text-nesta-aqua">Pro</span></h1>
                    <span class="text-[10px] font-bold tracking-[0.2em] uppercase opacity-70">Discovery Hub</span>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="downloadCSV()" class="btn-interactive px-4 py-2 text-sm font-bold text-white hover:text-nesta-aqua flex items-center gap-2 group border border-transparent hover:border-white/10 rounded">
                    <svg class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Export
                </button>
                <button onclick="openSavedSignals()" class="btn-interactive px-6 py-2 bg-white text-nesta-navy text-sm font-bold rounded-sm hover:bg-nesta-aqua hover:text-nesta-navy shadow-lg">
                    Full Database
                </button>
            </div>
        </div>
        <div class="h-1.5 w-full bg-gradient-to-r from-nesta-blue via-nesta-purple to-nesta-orange"></div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-6 py-10 space-y-10">
        
        <div class="bg-white rounded-xl shadow-soft p-10 space-y-10 relative overflow-hidden border border-gray-100">
            
            <div class="relative group transition-all duration-300 ease-out hover:-translate-y-1">
                <label for="topic-input" class="sr-only">Search</label>
                <input type="text" id="topic-input" name="topic"
                    class="w-full text-3xl md:text-4xl font-display text-nesta-navy placeholder-gray-300 border-2 border-gray-100 rounded-2xl py-6 px-8 shadow-soft focus:outline-none focus:border-nesta-blue focus:ring-4 focus:ring-nesta-blue/5 transition-all duration-300 bg-white hover:shadow-hover hover:border-nesta-blue/30 focus:scale-[1.01]"
                    placeholder="Scanning for... (e.g. 'Synthetic Biology')"
                    onkeypress="handleEnter(event)"
                    oninput="toggleButtonState()">
                <div class="absolute right-8 top-1/2 -translate-y-1/2 text-nesta-blue transition-all duration-500 ease-out group-focus-within:scale-110 group-focus-within:rotate-12 group-focus-within:text-nesta-aqua">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-10 items-end">
                
                <div class="md:col-span-4 space-y-3">
                    <label for="mission-select" class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest pl-1">Nesta Mission</label>
                    <div class="relative group transition-all duration-300 ease-out hover:-translate-y-1 bg-white rounded-2xl">
                        <select id="mission-select" name="mission" class="w-full appearance-none bg-transparent border-2 border-gray-100 text-nesta-navy font-bold text-lg py-4 px-6 rounded-2xl focus:outline-none focus:border-nesta-blue focus:ring-4 focus:ring-nesta-blue/5 cursor-pointer hover:border-nesta-blue/30 transition-all duration-300 shadow-soft hover:shadow-hover z-10 relative">
                            <option class="text-nesta-navy" value="All Missions">All Missions</option>
                            <option class="text-nesta-navy" value="A Fairer Start">A Fairer Start üìö</option>
                            <option class="text-nesta-navy" value="A Healthy Life">A Healthy Life ‚ù§Ô∏è‚Äçü©π</option>
                            <option class="text-nesta-navy" value="A Sustainable Future">A Sustainable Future üå≥</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-6 pointer-events-none text-nesta-navy group-hover:text-nesta-blue transition-colors duration-300 z-0">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-3 space-y-4">
                    <div class="flex justify-between items-baseline px-1">
                        <label for="signal-count" class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Quantity</label>
                        <span id="count-display" class="text-xs font-bold text-nesta-navy bg-nesta-aqua/20 px-3 py-1 rounded-full">5 Signals</span>
                    </div>
                    <input type="range" id="signal-count" name="count" min="1" max="10" value="5" 
                           oninput="document.getElementById('count-display').innerText = this.value + ' Signals'"
                           class="w-full">
                </div>

                <div class="md:col-span-5 flex flex-wrap gap-4 justify-end">
                    <div class="flex items-center gap-3 bg-gray-50 px-5 py-3 border border-nesta-sand rounded-lg cursor-pointer hover:border-nesta-orange/50 transition shadow-sm tech-toggle-group">
                        <input type="checkbox" id="tech-mode" name="tech_mode" class="w-5 h-5 text-nesta-orange border-gray-300 rounded focus:ring-nesta-orange bg-white checked:bg-nesta-orange checked:border-transparent cursor-pointer">
                        <label for="tech-mode" class="text-sm font-bold text-nesta-navy cursor-pointer select-none tech-toggle-label">Hard Tech Only</label>
                    </div>
                    
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchView('list')" id="btn-list" class="px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md hover:scale-105 active:scale-95">List</button>
                        <button onclick="switchView('radar')" id="btn-radar" class="px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md hover:scale-105 active:scale-95">Radar</button>
                    </div>
                </div>
            </div>

            <div class="pt-8 border-t border-gray-100 flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex flex-wrap gap-3" id="source-bias-container">
                    <div class="bias-chip relative"><input type="checkbox" id="bias-gtr" name="source_bias" value="Gateway to Research" class="peer sr-only"><label for="bias-gtr" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">Gateway to Research</label></div>
                    <div class="bias-chip relative"><input type="checkbox" id="bias-academia" name="source_bias" value="Academia" class="peer sr-only"><label for="bias-academia" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">Academia</label></div>
                    <div class="bias-chip relative"><input type="checkbox" id="bias-vc" name="source_bias" value="VC" class="peer sr-only"><label for="bias-vc" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">VC Blogs</label></div>
                    <div class="bias-chip relative"><input type="checkbox" id="bias-scimags" name="source_bias" value="Scientific Magazines" class="peer sr-only"><label for="bias-scimags" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">Sci Mags</label></div>
                    <div class="bias-chip relative"><input type="checkbox" id="bias-niche" name="source_bias" value="Niche Forums" class="peer sr-only"><label for="bias-niche" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">Niche Forums</label></div>
                </div>
                
                <div class="flex gap-4 w-full md:w-auto items-center">
                    
                    <div class="relative group">
                        <label for="time-filter" class="sr-only">Time Horizon</label>
                        <select id="time-filter" name="time_filter" class="appearance-none bg-white border-2 border-gray-100 text-nesta-navy font-bold text-sm py-3 pl-5 pr-10 rounded-full focus:outline-none focus:border-nesta-blue focus:ring-2 focus:ring-nesta-blue/5 cursor-pointer hover:border-nesta-blue/30 transition-all duration-300 shadow-sm hover:shadow-md hover:-translate-y-0.5">
                            <option class="text-nesta-navy">Past Month</option>
                            <option class="text-nesta-navy">Past 3 Months</option>
                            <option class="text-nesta-navy">Past 6 Months</option>
                            <option class="text-nesta-navy">Past Year</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-nesta-navy group-hover:text-nesta-blue transition-colors">
                             <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>

                    <div class="h-8 w-px bg-gray-200 mx-2"></div>
                    
                    <button onclick="generateSignal(true)" id="broad-btn" class="btn-interactive px-6 py-3 text-sm font-bold text-nesta-darkgrey hover:text-nesta-blue hover:bg-gray-50 rounded border border-transparent hover:border-nesta-blue/20">Broad Scan</button>
                    
                    <button id="search-btn" onclick="generateSignal(false)" class="hidden btn-interactive px-8 py-3 bg-nesta-blue text-white text-sm font-bold rounded shadow-lg hover:bg-blue-700 hover:shadow-xl flex items-center gap-3">
                        <span>Initiate Scan</span>
                    </button>
                    
                    <button id="stop-btn" onclick="stopScan()" class="hidden btn-interactive px-8 py-3 bg-nesta-red text-white text-sm font-bold rounded shadow-lg hover:bg-red-700 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        Stop
                    </button>
                </div>
            </div>
        </div>

        <div id="view-controls" class="flex justify-between items-center px-2">
            <h3 id="view-title" class="text-2xl brand-font text-nesta-navy">Signal Results</h3>
            <div class="flex gap-2 bg-white p-1.5 rounded-full shadow-sm border border-gray-100">
                <button onclick="switchFilter('scan')" id="filter-btn-scan" class="filter-view-btn active px-4 py-1.5 rounded-full text-xs font-bold border border-nesta-navy text-nesta-navy hover:bg-gray-100">Current Scan</button>
                <div class="h-6 w-px bg-gray-200 mx-1"></div>
                <button onclick="switchFilter('recent')" id="filter-btn-recent" class="filter-view-btn px-4 py-1.5 rounded-full text-xs font-bold border border-transparent text-gray-500 hover:bg-gray-50 hover:text-nesta-navy">Recent DB</button>
                <button onclick="switchFilter('funding')" id="filter-btn-funding" class="filter-view-btn px-4 py-1.5 rounded-full text-xs font-bold border border-transparent text-gray-500 hover:bg-gray-50 hover:text-nesta-navy">Funding</button>
                <button onclick="switchFilter('tech')" id="filter-btn-tech" class="filter-view-btn px-4 py-1.5 rounded-full text-xs font-bold border border-transparent text-gray-500 hover:bg-gray-50 hover:text-nesta-navy">Emerging Tech</button>
            </div>
        </div>

        <div id="result-container" class="grid grid-cols-1 gap-8"></div>
        
        <div id="radar-container" class="hidden bg-white p-10 shadow-soft border border-gray-100 min-h-[600px] flex flex-col items-center justify-center rounded-xl relative">
            <p class="text-xs text-gray-400 mb-4 uppercase tracking-widest mt-4">Click dots to view signal details</p>
            <div class="w-full h-[500px] relative"><canvas id="signalRadar"></canvas></div>
        </div>

        <section id="preview-section" class="pt-12 border-t border-gray-200">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-2xl brand-font text-nesta-navy">Recent Discoveries</h2>
                    <p class="text-sm text-nesta-darkgrey mt-1">Live updates from the shared database.</p>
                </div>
                <button onclick="openSavedSignals()" class="text-sm font-bold text-nesta-blue hover:text-nesta-navy transition flex items-center gap-1 group">
                    View All <span class="group-hover:translate-x-1 transition-transform">‚Üí</span>
                </button>
            </div>
            
            <div id="preview-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8 opacity-100">
                <div class="h-64 bg-white rounded-xl border border-gray-100 shadow-sm p-6 space-y-4 animate-pulse">
                    <div class="h-4 bg-gray-100 rounded w-1/3"></div>
                    <div class="h-6 bg-gray-100 rounded w-3/4"></div>
                    <div class="h-20 bg-gray-100 rounded"></div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-nesta-navy text-white mt-auto">
        <div class="h-1 w-full bg-gradient-to-r from-nesta-blue via-nesta-purple to-nesta-orange"></div>
        <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-6 h-6 bg-white text-nesta-navy flex items-center justify-center text-sm font-bold rounded-sm brand-font">N</div>
                <div class="flex flex-col">
                    <span class="text-sm font-display leading-none">Nesta Discovery Hub</span>
                </div>
            </div>
            <div class="text-[10px] font-body opacity-50 tracking-wide">
                &copy; 2025 NESTA. ALL RIGHTS RESERVED.
            </div>
        </div>
    </footer>

    <div id="saved-modal" class="fixed inset-0 bg-nesta-navy/90 backdrop-blur-md z-[100] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-7xl h-[85vh] shadow-2xl flex flex-col overflow-hidden rounded-2xl animate-fade-in-up">
            <div class="px-10 py-6 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h2 class="text-3xl brand-font text-nesta-navy">Signal Database</h2>
                    <p class="text-xs text-nesta-blue font-bold uppercase tracking-wider mt-1">Manage & Curate</p>
                </div>
                <button onclick="closeSavedSignals()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 transition rounded-full text-nesta-navy font-bold text-xl">‚úï</button>
            </div>
            <div id="saved-list" class="flex-1 overflow-y-auto p-10 bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-nesta-navy text-white px-6 py-4 shadow-2xl transform translate-y-24 opacity-0 transition-all duration-500 z-[120] font-bold text-sm flex items-center gap-4 rounded-lg border-l-4 border-nesta-aqua">
        <div class="w-2 h-2 rounded-full bg-nesta-aqua shrink-0"></div><span id="toast-msg">Action Successful</span>
    </div>

    <script>
        const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://127.0.0.1:8000' 
            : 'https://nesta-signal-backend.onrender.com';

        // --- GLOBAL STATE ---
        let currentSignals = []; // Displayed signals (Scan or DB View)
        let lastScanResults = []; // Cache for "Current Scan" view
        let currentSaved = []; // Full DB cache
        let activeFilter = 'scan'; // Track current filter
        
        let radarChart = null;
        let isProcessing = false;
        let scanController = null;
        let loadIntervals = [];

        const MISSION_EMOJIS = { 'A Fairer Start': 'üìö', 'A Healthy Life': '‚ù§Ô∏è‚Äçü©π', 'A Sustainable Future': 'üå≥' };
        const LENS_EMOJIS = { 'Social': 'üë•', 'Tech': 'ü§ñ', 'Media': 'üéôÔ∏è', 'Powerhouse': '‚ö°' };
        
        // Nesta Mission Colors for Radar
        const MISSION_COLORS = {
            'A Fairer Start': '#FDB633', // Yellow
            'A Healthy Life': '#F6A4B7', // Pink
            'A Sustainable Future': '#18A48C', // Green
            'Default': '#646363' // Dark Grey for Mission Adjacent/Others
        };

        async function warmBackend() {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 5000);
            try {
                const res = await fetch(`${API_BASE_URL}/`, { method: 'GET', cache: 'no-store', signal: controller.signal });
                return res.ok;
            } catch (err) {
                console.error('Backend warmup failed', err);
                return false;
            } finally {
                clearTimeout(timeout);
            }
        }

        async function initDashboard() {
            const ready = await warmBackend();
            if (!ready) {
                showToast('Backend offline. Retrying...', 'error');
                setTimeout(loadPreview, 1500);
                return;
            }
            loadPreview();
            toggleButtonState(); 
            // Init with empty scan view
            switchFilter('scan');
        }

        function toggleButtonState() {
            if (isProcessing) return;
            const input = document.getElementById('topic-input');
            const broadBtn = document.getElementById('broad-btn');
            const searchBtn = document.getElementById('search-btn');
            const hasText = input.value.trim().length > 0;

            if (hasText) {
                broadBtn.classList.add('hidden');
                searchBtn.classList.remove('hidden');
            } else {
                broadBtn.classList.remove('hidden');
                searchBtn.classList.add('hidden');
            }
        }

        // --- LOADING ANIMATION LOGIC ---
        function startLoadingSimulation(requestedCount) {
            const statuses = [
                "Initializing Scout Agent...", "Scanning Global Sources...", "Filtering Mainstream Noise...",
                "Applying Friction Method...", "Scoring Novelty & Evidence...", "Synthesizing Intelligence..."
            ];
            let statusIndex = 0;
            stopLoadingSimulation(); 

            // Base duration roughly 25s for 1 signal, scaling up non-linearly
            // e.g., 5 signals might take 45s, 10 signals ~70s
            // This is just a simulation, but gives feedback based on request size.
            const SIMULATION_BASE_FACTOR = 250;
            const DEFAULT_REQUEST_COUNT = 5;
            const COUNT_MULTIPLIER = 40;

            const baseFactor = SIMULATION_BASE_FACTOR;
            const countFactor = (requestedCount || DEFAULT_REQUEST_COUNT) * COUNT_MULTIPLIER;
            const speed = baseFactor + countFactor;

            const statInt = setInterval(() => {
                statusIndex = (statusIndex + 1) % statuses.length;
                const el = document.getElementById('loading-status-text');
                if(el) {
                    el.style.opacity = '0';
                    setTimeout(() => { el.innerText = statuses[statusIndex]; el.style.opacity = '1'; }, 200);
                }
            }, 3500);
            loadIntervals.push(statInt);

            let progress = 0;
            const progInt = setInterval(() => {
                if(progress < 99) {
                    let increment = (100 - progress) / speed;
                    if(increment < 0.05) increment = 0.05; 
                    progress += increment;
                    const textEl = document.getElementById('loading-percent-text');
                    const barEl = document.getElementById('loading-bar-inner');
                    if(textEl) textEl.innerText = Math.floor(progress) + '%';
                    if(barEl) barEl.style.width = progress + '%';
                }
            }, 100);
            loadIntervals.push(progInt);
        }

        function stopLoadingSimulation() {
            loadIntervals.forEach(clearInterval);
            loadIntervals = [];
        }

        function getMissionEmoji(mission) {
            for (const [key, emoji] of Object.entries(MISSION_EMOJIS)) { if (mission.includes(key)) return emoji; }
            return ''; 
        }

        function getMissionColor(mission) {
            if (!mission) return MISSION_COLORS['Default'];
            for (const [key, color] of Object.entries(MISSION_COLORS)) {
                if (mission.includes(key)) return color;
            }
            return MISSION_COLORS['Default'];
        }

        function formatSource(url) {
            try {
                const hostname = new URL(url).hostname.replace('www.', '');
                const name = hostname.split('.')[0];
                return name.length <= 3 ? name.toUpperCase() : name.charAt(0).toUpperCase() + name.slice(1);
            } catch { return 'Source'; }
        }

        function cleanText(text) {
            if (!text) return "";
            let clean = text.replace(/^In \d{4},?\s*/i, "");
            clean = clean.replace(/\[[^\]]*\]/g, "").replace(/\\/g, "");
            return clean;
        }

        function getLensBadges(lensesStr, styleClass) {
            if (!lensesStr) return '';
            const style = styleClass || "bg-gray-50 text-nesta-darkgrey border-gray-200"; 
            const tags = lensesStr.split(',').map(t => t.trim());
            let html = '<div class="flex flex-wrap gap-2 mb-4">';
            tags.forEach(tag => {
                let emoji = '';
                for (const [key, icon] of Object.entries(LENS_EMOJIS)) {
                    if (tag.toLowerCase().includes(key.toLowerCase())) emoji = icon;
                }
                if (emoji) {
                    html += `<span class="px-2 py-1 border rounded text-[10px] font-bold ${style}" title="${tag}">${emoji} ${tag}</span>`;
                }
            });
            html += '</div>';
            return html;
        }

        // --- DATA MANAGEMENT ---
        async function ensureDatabaseLoaded() {
            if (currentSaved.length === 0) {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/saved`);
                    if(!res.ok) throw new Error();
                    currentSaved = (await res.json()).reverse(); // Newest first
                } catch(e) { console.error("DB Load Error", e); }
            }
        }

        async function loadPreview() {
            const grid = document.getElementById('preview-grid');
            try {
                await ensureDatabaseLoaded();
                const data = currentSaved;
                if(!data || data.length === 0) { grid.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-400">Database empty.</div>'; return; }
                
                const recent = data.slice(0, 3);
                
                grid.innerHTML = ''; 
                recent.forEach((sig, i) => {
                    const normalized = normalizeSignal(sig);
                    createSignalCard(normalized, i, false, 'preview-grid');
                });
            } catch(e) { grid.innerHTML = '<div class="col-span-3 text-center text-xs text-red-400 py-10">Database Offline</div>'; }
        }

        function normalizeSignal(sig) {
            return {
                title: sig.Title || sig.title, 
                score: sig.Score || sig.score, 
                hook: sig.Hook || sig.hook, 
                final_url: sig.URL || sig.final_url || sig.url,
                mission: sig.Mission || sig.mission, 
                lenses: sig.Lenses || sig.lenses, 
                score_novelty: sig.Score_Novelty || sig.score_novelty, 
                score_evidence: sig.Score_Evidence || sig.score_evidence, 
                score_evocativeness: sig.Score_Evocativeness || sig.score_evocativeness,
                shareable: sig.Shareable || sig.shareable, 
                feedback: sig.Feedback || sig.User_Comment || sig.feedback,
                _row: sig._row, 
                source_date: sig.Source_Date || sig.source_date
            };
        }

        // --- UNIFIED FILTER LOGIC ---
        async function switchFilter(type) {
            activeFilter = type;
            
            // UI Toggle
            document.querySelectorAll('.filter-view-btn').forEach(b => {
                b.classList.remove('active', 'bg-nesta-navy', 'text-white', 'border-nesta-navy');
                b.classList.add('text-gray-500', 'border-transparent');
            });
            const btn = document.getElementById(`filter-btn-${type}`);
            if(btn) {
                btn.classList.add('active', 'bg-nesta-navy', 'text-white', 'border-nesta-navy');
                btn.classList.remove('text-gray-500', 'border-transparent');
            }

            // Data Logic
            const listContainer = document.getElementById('result-container');
            
            if (type === 'scan') {
                if (lastScanResults.length === 0) {
                    currentSignals = [];
                    listContainer.innerHTML = `<div class="col-span-full py-16 text-center border-2 border-dashed border-gray-200 rounded-xl"><p class="text-nesta-darkgrey font-bold">No active scan results.</p><p class="text-xs text-gray-400 mt-1">Enter a topic above to initiate a scan.</p></div>`;
                    renderRadar(); // Clears radar
                    return;
                }
                currentSignals = lastScanResults;
            } else {
                await ensureDatabaseLoaded();
                if (currentSaved.length === 0) {
                    listContainer.innerHTML = `<div class="text-center py-10">Database offline or empty.</div>`;
                    return;
                }
                
                let filtered = [];
                if (type === 'recent') {
                    filtered = currentSaved.slice(0, 10);
                } else if (type === 'funding') {
                    const keywords = ['fund', 'invest', 'venture', 'capital', 'raise', 'grant', 'million', 'billion', 'round'];
                    filtered = currentSaved.filter(s => {
                        const txt = ((s.Title||'') + (s.Hook||'') + (s.User_Comment||'')).toLowerCase();
                        return keywords.some(k => txt.includes(k));
                    });
                } else if (type === 'tech') {
                    filtered = currentSaved.filter(s => {
                        const lenses = (s.Lenses || '').toLowerCase();
                        const hook = (s.Hook || '').toLowerCase();
                        return lenses.includes('tech') || hook.includes('ai') || hook.includes('quantum') || hook.includes('novel');
                    });
                }
                currentSignals = filtered.map(normalizeSignal);
            }
            
            // Re-render both views
            renderList(); 
            renderRadar();
        }

        function renderList() {
            const container = document.getElementById('result-container');
            container.innerHTML = '';
            currentSignals.forEach((sig, i) => createSignalCard(sig, i));
        }

        function showToast(msg, type='success') {
            const el = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const dot = el.querySelector('div');
            dot.className = `w-2 h-2 rounded-full ${type === 'error' ? 'bg-nesta-red' : 'bg-nesta-aqua'}`;
            el.className = `fixed bottom-8 right-8 bg-nesta-navy text-white px-6 py-4 shadow-2xl transform transition-all duration-500 z-[120] font-bold text-sm flex items-center gap-4 rounded-lg border-l-4 ${type === 'error' ? 'border-nesta-red' : 'border-nesta-aqua'}`;
            el.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => el.classList.add('translate-y-24', 'opacity-0'), 3000);
        }

        function handleEnter(e) { if(e.key === 'Enter') generateSignal(false); }
        function getCheckedSources() { return Array.from(document.querySelectorAll('#source-bias-container input:checked')).map(cb => cb.value); }

        function switchView(view) {
            const list = document.getElementById('result-container');
            const radar = document.getElementById('radar-container');
            const btnList = document.getElementById('btn-list');
            const btnRadar = document.getElementById('btn-radar');
            
            if(view === 'list') {
                list.classList.remove('hidden'); radar.classList.add('hidden');
                btnList.className = "px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md";
                btnRadar.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
            } else {
                list.classList.add('hidden'); radar.classList.remove('hidden');
                btnRadar.className = "px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md";
                btnList.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
                renderRadar(); // Ensure radar renders when switched to
            }
        }

        function setScanningState(isScanning) {
            const startBtn = document.getElementById('search-btn');
            const broadBtn = document.getElementById('broad-btn');
            const stopBtn = document.getElementById('stop-btn');

            if (isScanning) {
                startBtn.classList.add('hidden');
                broadBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
            } else {
                stopBtn.classList.add('hidden');
                toggleButtonState();
            }
        }

        function stopScan() {
            if (scanController) {
                scanController.abort();
                scanController = null;
                showToast('Scan Cancelled', 'error');
            }
        }

        async function generateSignal(isBroad) {
            if (isProcessing) return;
            const topic = document.getElementById('topic-input').value;
            const container = document.getElementById('result-container');
            const signalCount = parseInt(document.getElementById('signal-count').value) || 5;
            
            if (!topic && !isBroad) return showToast("Please enter a topic", "error");

            isProcessing = true;
            setScanningState(true); 
            switchView('list');
            // Force filter to 'scan' mode
            switchFilter('scan'); 
            
            container.innerHTML = `
                <div class="col-span-full py-24 flex flex-col items-center justify-center space-y-8 animate-fade-in-up">
                    <div class="radar-loader w-16 h-16 border-4 border-t-nesta-blue"></div>
                    <div class="w-full max-w-md space-y-2">
                        <div class="flex justify-between items-end px-1">
                            <p id="loading-status-text" class="font-display text-xl text-nesta-navy transition-opacity duration-200">Initializing Scout Agent...</p>
                            <p id="loading-percent-text" class="font-bold text-nesta-blue text-xl">0%</p>
                        </div>
                        <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                            <div id="loading-bar-inner" class="h-full bg-gradient-to-r from-nesta-blue to-nesta-aqua w-0 transition-all duration-100 ease-out"></div>
                        </div>
                        <p class="text-[10px] font-bold text-nesta-darkgrey uppercase tracking-widest text-center pt-2">AI Analysis in Progress</p>
                    </div>
                </div>`;
            
            startLoadingSimulation(signalCount);

            const missionSelectValue = document.getElementById('mission-select').value;

            const payload = {
                message: isBroad 
                    ? `Find ${signalCount} high-novelty weak signals related to ${missionSelectValue}. Context: ${topic}` 
                    : `Find ${signalCount} signals about ${topic} for ${missionSelectValue}`,
                time_filter: document.getElementById('time-filter').value,
                source_types: getCheckedSources(),
                tech_mode: document.getElementById('tech-mode').checked,
                mission: missionSelectValue
            };

            scanController = new AbortController();
            const signal = scanController.signal;

            try {
                const backendReady = await warmBackend();
                if (!backendReady) {
                    stopLoadingSimulation();
                    container.innerHTML = `<div class="p-8 bg-white border-l-4 border-nesta-red shadow-sm text-center"><p class="font-bold text-nesta-red">Backend Offline</p><p class="text-sm text-gray-500">Could not reach the scanning service. Trying again in a moment...</p></div>`;
                    showToast('Could not reach backend. Please retry.', 'error');
                    return;
                }

                const res = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                    signal: signal 
                });
                
                if(!res.ok) throw new Error();
                const data = await res.json();
                
                stopLoadingSimulation();
                container.innerHTML = '';

                if (data.ui_type === 'signal_list') {
                    currentSignals = data.items.map(normalizeSignal);
                    lastScanResults = currentSignals; 
                    
                    data.items.forEach((item, index) => {
                        setTimeout(() => createSignalCard(item, index), index * 100);
                    });
                    
                    setTimeout(loadPreview, 2000);
                } else {
                    container.innerHTML = `<div class="p-10 bg-white border border-gray-100 rounded-xl text-center text-nesta-navy shadow-sm">${data.content}</div>`;
                }
            } catch (error) {
                stopLoadingSimulation();
                if (error.name === 'AbortError') {
                    container.innerHTML = `<div class="p-10 text-center text-gray-400">Scan cancelled.</div>`;
                } else {
                    container.innerHTML = `<div class="p-8 bg-white border-l-4 border-nesta-red shadow-sm text-center"><p class="font-bold text-nesta-red">Connection Failed</p><p class="text-sm text-gray-500">Please check your internet or try again later.</p></div>`;
                }
            } finally {
                isProcessing = false;
                scanController = null;
                setScanningState(false);
            }
        }

        function createSignalCard(signal, index, isSavedView = false, containerId = 'result-container') {
            const container = document.getElementById(containerId);
            const m = (signal.mission || "").toLowerCase();
            
            // --- STYLING CONFIGURATION ---
            let styles = {
                cardBg: "bg-nesta-darkgrey",
                barColor: "bg-nesta-darkgrey", 
                badge: "bg-white text-nesta-navy", 
                title: "text-white hover:text-nesta-aqua",
                desc: "text-white", 
                accentLabel: "text-white", 
                scoreVal: "text-white",
                gridBg: "bg-white/5 border-white/10", 
                lens: "bg-white/10 text-white border-white/20",
                footer: "text-gray-300",
                inputBg: "bg-white/10 text-white border-white/20 placeholder-gray-400 focus:border-nesta-aqua",
                selectBg: "bg-nesta-navy text-white border-white/20",
                button: "bg-nesta-aqua text-nesta-navy hover:bg-white"
            };

            function colorCardOverrides(bgColor) {
                return {
                    cardBg: bgColor,
                    barColor: bgColor, 
                    badge: "bg-white text-nesta-navy", 
                    title: "text-nesta-navy hover:text-white",
                    desc: "text-nesta-navy", 
                    accentLabel: "text-nesta-navy", 
                    scoreVal: "text-nesta-navy",
                    gridBg: "bg-white/20 border-white/20", 
                    lens: "bg-white/40 text-nesta-navy border-white/20",
                    footer: "text-nesta-navy/70",
                    inputBg: "bg-white/40 text-nesta-navy border-white/30 placeholder-nesta-navy/50 focus:border-nesta-navy",
                    selectBg: "bg-white/40 text-nesta-navy border-white/30",
                    button: "bg-nesta-navy text-white hover:bg-white hover:text-nesta-navy"
                };
            }

            if (m.includes("fairer")) { styles = { ...styles, ...colorCardOverrides("bg-nesta-yellow") }; }
            else if (m.includes("sustainable")) { styles = { ...styles, ...colorCardOverrides("bg-nesta-green") }; }
            else if (m.includes("healthy")) { styles = { ...styles, ...colorCardOverrides("bg-nesta-pink") }; }

            const missionEmoji = getMissionEmoji(signal.mission || '');
            const sourceName = formatSource(signal.final_url || signal.url);
            const lensTags = getLensBadges(signal.lenses || '', styles.lens);
            const cleanHook = cleanText(signal.hook);
            const accentClass = `text-[9px] uppercase font-bold mb-1 tracking-wider ${styles.accentLabel}`;

            const card = document.createElement('div');
            card.id = `${containerId}-card-${index}`;
            card.className = `${styles.cardBg} p-7 border border-black/5 flex flex-col h-full shadow-soft rounded-xl animate-fade-in-up transition-all duration-300 transform hover:-translate-y-1`;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-5">
                    <span class="px-3 py-1 rounded-sm text-[10px] font-bold uppercase tracking-widest ${styles.badge}">
                        ${missionEmoji} ${signal.mission || 'General'}
                    </span>
                    <span class="flex items-center justify-center w-8 h-8 bg-nesta-black text-white font-bold text-sm rounded-full shadow-md">
                        ${signal.score || '-'}
                    </span>
                </div>
                
                <h3 class="text-2xl brand-font mb-3 leading-tight transition-colors ${styles.title}">
                    <a href="${signal.final_url || signal.url}" target="_blank" class="hover:underline decoration-2 underline-offset-4 decoration-current opacity-90 hover:opacity-100">${signal.title}</a>
                </h3>
                
                ${lensTags}

                <p class="text-sm mb-6 leading-relaxed flex-grow font-body ${styles.desc}">${cleanHook}</p>
                
                <div class="grid grid-cols-3 gap-2 py-4 border-t border-b mb-5 rounded-sm ${styles.gridBg}">
                     <div class="text-center">
                        <div class="${accentClass}">Novelty</div>
                        <div class="font-bold text-lg ${styles.scoreVal}">${signal.score_novelty}/10</div>
                     </div>
                     <div class="text-center border-l border-black/5">
                        <div class="${accentClass}">Evidence</div>
                        <div class="font-bold text-lg ${styles.scoreVal}">${signal.score_evidence}/10</div>
                     </div>
                     <div class="text-center border-l border-black/5">
                        <div class="${accentClass}">Impact</div>
                        <div class="font-bold text-lg ${styles.scoreVal}">${signal.score_evocativeness}/10</div>
                     </div>
                </div>
                
                <div class="flex items-center justify-between text-xs font-bold mt-auto ${styles.footer}">
                    <span>${signal.source_date || 'Recent'}</span>
                    <a href="${signal.final_url || signal.url}" target="_blank" class="flex items-center gap-1 hover:opacity-100 opacity-70 transition group">
                        ${sourceName} <span class="text-lg leading-none group-hover:translate-x-0.5 transition-transform">‚Üó</span>
                    </a>
                </div>

                ${isSavedView ? `
                <div class="mt-5 pt-5 border-t border-black/5 space-y-4">
                    <div class="space-y-1">
                        <label for="saved-shareable-${index}" class="${accentClass}">Status</label>
                        <select id="saved-shareable-${index}" class="w-full text-xs rounded px-3 py-2 font-bold focus:ring-0 focus:border-current ${styles.selectBg}">
                            <option value="Yes" ${signal.shareable === 'Yes' ? 'selected' : ''}>Yes - Shareable</option>
                            <option value="Maybe" ${signal.shareable === 'Maybe' ? 'selected' : ''}>Maybe</option>
                            <option value="No" ${signal.shareable === 'No' ? 'selected' : ''}>No - Reject</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                         <label for="saved-comment-${index}" class="${accentClass}">Notes</label>
                         <input type="text" id="saved-comment-${index}" class="w-full text-xs px-3 py-2 rounded focus:ring-0 ${styles.inputBg}" placeholder="Add comment..." value="${signal.feedback || ''}">
                    </div>
                    <button onclick="updateSavedSignal('${signal.final_url || signal.url}', '${(signal.title || "").replace(/'/g, "\\'")}', ${index})" class="w-full py-2.5 text-xs font-bold uppercase rounded transition shadow-md ${styles.button}">Save Changes</button>
                </div>` : ''}
            `;
            container.appendChild(card);
        }

        async function openSavedSignals() {
            document.getElementById('saved-modal').classList.remove('hidden');
            const list = document.getElementById('saved-list');
            list.innerHTML = '<div class="col-span-full py-24 text-center flex flex-col items-center"><div class="radar-loader mb-4 border-2 border-gray-200 border-t-nesta-blue w-10 h-10"></div><p class="font-bold text-nesta-navy">Retrieving Intelligence...</p></div>';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/saved`);
                const data = await res.json();
                list.innerHTML = '';
                // NEWEST FIRST for full database view as well
                currentSaved = data.reverse(); 
                if(data.length === 0) { list.innerHTML = '<div class="col-span-full text-center py-20 text-gray-400">Database is empty.</div>'; return; }
                
                currentSaved.forEach((sig, i) => {
                    const normalized = normalizeSignal(sig);
                    createSignalCard(normalized, i, true, 'saved-list');
                });
            } catch(e) { list.innerHTML = '<div class="col-span-full text-center text-nesta-red py-10 font-bold">Failed to load database.</div>'; }
        }

        function closeSavedSignals() { document.getElementById('saved-modal').classList.add('hidden'); }

        async function updateSavedSignal(url, title, domIndex) {
            const shareVal = document.getElementById(`saved-shareable-${domIndex}`).value;
            const commentVal = document.getElementById(`saved-comment-${domIndex}`)?.value || '';
            try {
                const res = await fetch(`${API_BASE_URL}/api/update`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url, title, shareable: shareVal, user_status: shareVal === 'No' ? 'Rejected' : 'Accepted', user_comment: commentVal, feedback: commentVal })
                });
                if(res.ok) { showToast('Database updated'); currentSaved = []; loadPreview(); }
                else throw new Error();
            } catch(e) { showToast('Update failed', 'error'); }
        }

        function downloadCSV() {
            if(!currentSaved || currentSaved.length === 0) return showToast('No data to export', 'error');
            let csv = "Title,URL,Score,Mission,Hook,Date,Status,Notes\n";
            currentSaved.forEach(r => { csv += `"${r.Title}","${r.URL}",${r.Score},"${r.Mission}","${(r.Hook||"").replace(/"/g, '""')}",${r.Source_Date},${r.Shareable},"${r.User_Comment||""}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Signal_Export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // --- INTERACTIVE RADAR ---
        function scrollToCard(index) {
            switchView('list'); 
            const cardId = `result-container-card-${index}`;
            const card = document.getElementById(cardId);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.classList.add('card-highlight');
                setTimeout(() => card.classList.remove('card-highlight'), 2000);
            }
        }

        function renderRadar() {
            if(radarChart) radarChart.destroy();
            const ctx = document.getElementById('signalRadar').getContext('2d');
            const dataPoints = currentSignals.map((s, i) => ({ 
                x: s.score_novelty || Math.random()*10, 
                y: s.score_evidence || Math.random()*10, 
                r: (s.score/10)||5, 
                title: s.title,
                mission: s.mission,
                index: i 
            }));
            
            const pointColors = dataPoints.map(p => getMissionColor(p.mission));

            radarChart = new Chart(ctx, {
                type: 'bubble',
                data: { datasets: [{ 
                    label: 'Active Signals', 
                    data: dataPoints, 
                    backgroundColor: pointColors, 
                    borderColor: pointColors, 
                    borderWidth: 1, 
                    hoverBackgroundColor: '#0F294A', 
                    hoverBorderColor: '#0F294A' 
                }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const dataIndex = activeElements[0].index; 
                            const point = dataPoints[dataIndex];
                            scrollToCard(point.index);
                        }
                    },
                    scales: { 
                        x: { title: { display: true, text: 'NOVELTY (Distance from Mainstream)', font: { weight: 'bold', family: 'Averta' }, color: '#0F294A' }, min: 0, max: 10, grid: { color: '#E5E7EB' } }, 
                        y: { title: { display: true, text: 'EVIDENCE (Reality Factor)', font: { weight: 'bold', family: 'Averta' }, color: '#0F294A' }, min: 0, max: 10, grid: { color: '#E5E7EB' } } 
                    }, 
                    plugins: { 
                        tooltip: { backgroundColor: '#0F294A', titleFont: { family: 'Zosia Display', size: 14 }, bodyFont: { family: 'Averta' }, padding: 12, callbacks: { label: function(context) { return context.raw.title; } } }, 
                        legend: { display: false } 
                    } 
                }
            });
        }
    </script>
</body>
</html>
