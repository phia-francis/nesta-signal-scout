<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nesta Signal Scout Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nesta: {
                            blue: '#0000FF',       // Hero [cite: 141-145]
                            green: '#18A48C',      // Sustainable Future [cite: 146-148]
                            aqua: '#97D9E3',       // Fairer Start Support [cite: 149-150]
                            purple: '#9A1BBE',     // Healthy Life [cite: 151-152]
                            violet: '#A59BEE',     // Healthy Life Support [cite: 153-154]
                            red: '#EB003B',        // Accent [cite: 155-156]
                            pink: '#F6A4B7',       // Accent [cite: 157-158]
                            orange: '#FF6E47',     // Accent [cite: 159-160]
                            yellow: '#FDB633',     // Sustainable Support [cite: 161-162]
                            navy: '#0F294A',       // Text/Structure [cite: 167-171]
                            darkgrey: '#646363',   // Text [cite: 163-165]
                            sand: '#D2C9C0',       // Backgrounds [cite: 164-166]
                            black: '#000000',      // [cite: 174-177]
                            white: '#FFFFFF'       // [cite: 172-173]
                        }
                    },
                    fontFamily: {
                        display: ['"Zosia Display"', 'sans-serif'], // [cite: 230-232]
                        body: ['"Averta"', 'sans-serif']           // 
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* FONTS: Assumes files are in the root directory */
        @font-face { font-family: 'Zosia Display'; src: url('Zosia-Display.woff2') format('woff2'); font-weight: bold; font-style: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Regular.otf') format('opentype'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Semibold.otf') format('opentype'); font-weight: bold; font-style: normal; }

        body { font-family: 'Averta', sans-serif; background-color: #F9FAFB; color: #0F294A; }
        h1, h2, h3, .brand-font { font-family: 'Zosia Display', sans-serif; }

        /* UTILITIES */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(15, 41, 74, 0.05); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 0, 255, 0.15); }
        
        /* CUSTOM RANGE SLIDER (Nesta Blue Thumb) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #0000FF; cursor: pointer; margin-top: -8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #D2C9C0; border-radius: 2px;
        }

        /* LOADING SPINNER (Nesta Blue) */
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased bg-[#F9FAFB]" onload="initDashboard()">

    <header class="bg-white/95 backdrop-blur-md border-b border-nesta-sand/30 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-nesta-black text-white flex items-center justify-center text-xl font-bold rounded-sm brand-font">N</div>
                <div class="flex flex-col">
                    <h1 class="text-2xl leading-none text-nesta-navy">Signal Scout <span class="text-nesta-blue">Pro</span></h1>
                    <span class="text-[10px] font-bold tracking-widest uppercase text-nesta-darkgrey">Discovery Hub</span>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="downloadCSV()" class="px-4 py-2 text-sm font-bold text-nesta-navy hover:text-nesta-blue transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Export
                </button>
                <button onclick="openSavedSignals()" class="px-5 py-2 bg-nesta-navy text-white text-sm font-bold rounded hover:bg-nesta-blue transition shadow-lg shadow-nesta-navy/10">
                    Full Database
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-6 py-10 space-y-12">
        
        <div class="bg-white rounded-none border-l-4 border-nesta-blue shadow-sm p-8 space-y-8 relative overflow-hidden group">
            <div class="relative">
                <input type="text" id="topic-input" 
                    class="w-full text-3xl font-display text-nesta-navy placeholder-nesta-sand border-b-2 border-nesta-sand/30 py-4 focus:outline-none focus:border-nesta-blue transition-colors bg-transparent"
                    placeholder="Scanning for... (e.g. 'Synthetic Biology')"
                    onkeypress="handleEnter(event)">
                <div class="absolute right-0 top-6 text-nesta-blue">
                    <svg class="w-8 h-8 animate-pulse-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-8 items-end">
                <div class="md:col-span-4 space-y-3">
                    <label class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Nesta Mission</label>
                    <div class="relative">
                        <select id="mission-select" class="w-full appearance-none bg-nesta-sand/20 border-b border-nesta-sand text-nesta-navy font-bold py-3 px-4 rounded-t focus:ring-0 focus:border-nesta-blue cursor-pointer">
                            <option value="All Missions">All Missions</option>
                            <option value="A Fairer Start">A Fairer Start üìö</option>
                            <option value="A Healthy Life">A Healthy Life ‚ù§Ô∏è‚Äçü©π</option>
                            <option value="A Sustainable Future">A Sustainable Future üå≥</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-nesta-navy">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-3 space-y-3">
                    <div class="flex justify-between">
                        <label class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Quantity</label>
                        <span id="count-display" class="text-xs font-bold text-nesta-blue bg-blue-50 px-2 py-0.5 rounded">5 Signals</span>
                    </div>
                    <input type="range" id="signal-count" min="1" max="10" value="5" 
                           oninput="document.getElementById('count-display').innerText = this.value + ' Signals'"
                           class="w-full">
                </div>

                <div class="md:col-span-5 flex flex-wrap gap-4 justify-end">
                    <label class="flex items-center gap-3 bg-white px-4 py-3 border border-nesta-sand rounded-none cursor-pointer hover:border-nesta-blue transition">
                        <input type="checkbox" id="tech-mode" class="w-5 h-5 text-nesta-blue border-nesta-sand rounded-sm focus:ring-nesta-blue">
                        <span class="text-sm font-bold text-nesta-navy">Hard Tech Only</span>
                    </label>
                    
                    <div class="flex bg-nesta-sand/30 p-1">
                        <button onclick="switchView('list')" id="btn-list" class="px-4 py-2 text-xs font-bold transition shadow-sm bg-white text-nesta-navy">List</button>
                        <button onclick="switchView('radar')" id="btn-radar" class="px-4 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy">Radar</button>
                    </div>
                </div>
            </div>

            <div class="pt-6 border-t border-nesta-sand/30 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex flex-wrap gap-2" id="source-bias-container">
                    <label class="bias-chip cursor-pointer select-none"><input type="checkbox" value="Academia" class="peer sr-only"><span class="px-3 py-1.5 border border-nesta-sand text-xs font-bold text-nesta-darkgrey peer-checked:bg-nesta-navy peer-checked:text-white peer-checked:border-nesta-navy transition-all">Academia</span></label>
                    <label class="bias-chip cursor-pointer select-none"><input type="checkbox" value="VC" class="peer sr-only"><span class="px-3 py-1.5 border border-nesta-sand text-xs font-bold text-nesta-darkgrey peer-checked:bg-nesta-navy peer-checked:text-white peer-checked:border-nesta-navy transition-all">VC Blogs</span></label>
                    <label class="bias-chip cursor-pointer select-none"><input type="checkbox" value="Scientific Magazines" class="peer sr-only"><span class="px-3 py-1.5 border border-nesta-sand text-xs font-bold text-nesta-darkgrey peer-checked:bg-nesta-navy peer-checked:text-white peer-checked:border-nesta-navy transition-all">Sci Mags</span></label>
                    <label class="bias-chip cursor-pointer select-none"><input type="checkbox" value="Niche Forums" class="peer sr-only"><span class="px-3 py-1.5 border border-nesta-sand text-xs font-bold text-nesta-darkgrey peer-checked:bg-nesta-navy peer-checked:text-white peer-checked:border-nesta-navy transition-all">Niche Forums</span></label>
                </div>
                
                <div class="flex gap-4 w-full md:w-auto">
                    <select id="time-filter" class="bg-transparent text-sm font-bold text-nesta-darkgrey focus:outline-none hover:text-nesta-blue cursor-pointer">
                        <option>Past Month</option>
                        <option>Past 3 Months</option>
                        <option>Past 6 Months</option>
                        <option>Past Year</option>
                    </select>
                    <button onclick="generateSignal(true)" class="px-6 py-3 text-sm font-bold text-nesta-darkgrey hover:text-nesta-blue hover:bg-blue-50 transition">Broad Scan</button>
                    <button id="search-btn" onclick="generateSignal(false)" class="px-8 py-3 bg-nesta-blue text-white text-sm font-bold shadow-lg hover:shadow-xl hover:bg-blue-700 transition flex items-center gap-3">
                        <span>Initiate Scan</span>
                        <div id="btn-loader" class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>

        <div id="result-container" class="grid grid-cols-1 gap-6"></div>
        <div id="radar-container" class="hidden bg-white p-8 shadow-sm border border-nesta-sand min-h-[500px] flex flex-col items-center justify-center">
            <h3 class="text-xl brand-font mb-6 text-nesta-navy">Innovation Landscape</h3>
            <div class="w-full h-[450px] relative"><canvas id="signalRadar"></canvas></div>
        </div>

        <section id="preview-section" class="pt-8 border-t border-nesta-sand/30">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl brand-font text-nesta-navy">Recent Discoveries</h2>
                    <p class="text-sm text-nesta-darkgrey">The latest signals added to your shared database.</p>
                </div>
                <button onclick="openSavedSignals()" class="text-sm font-bold text-nesta-blue hover:text-nesta-navy transition">View All ‚Üí</button>
            </div>
            
            <div id="preview-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 opacity-60 hover:opacity-100 transition-opacity duration-500">
                <div class="h-64 bg-nesta-sand/10 rounded border border-nesta-sand animate-pulse"></div>
                <div class="h-64 bg-nesta-sand/10 rounded border border-nesta-sand animate-pulse"></div>
                <div class="h-64 bg-nesta-sand/10 rounded border border-nesta-sand animate-pulse"></div>
            </div>
        </section>

    </main>

    <footer class="bg-nesta-navy text-white mt-auto">
        <div class="h-1 w-full bg-gradient-to-r from-nesta-blue via-nesta-green to-nesta-purple"></div>
        
        <div class="max-w-7xl mx-auto px-6 py-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white text-nesta-navy flex items-center justify-center text-lg font-bold rounded-sm brand-font">N</div>
                <div class="flex flex-col">
                    <span class="text-lg font-display leading-none">Nesta Discovery Hub</span>
                    <span class="text-[10px] uppercase tracking-widest opacity-60">Foresight & Innovation</span>
                </div>
            </div>
            <div class="text-xs font-body opacity-60">
                &copy; 2025 Nesta. All rights reserved.
            </div>
        </div>
    </footer>

    <div id="saved-modal" class="fixed inset-0 bg-nesta-navy/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-6xl h-[90vh] shadow-2xl flex flex-col overflow-hidden">
            <div class="px-8 py-6 border-b border-nesta-sand flex justify-between items-center bg-gray-50">
                <div>
                    <h2 class="text-3xl brand-font text-nesta-navy">Signal Database</h2>
                    <p class="text-xs text-nesta-blue font-bold uppercase tracking-wider mt-1">Review & Curate Findings</p>
                </div>
                <button onclick="closeSavedSignals()" class="w-8 h-8 flex items-center justify-center hover:bg-nesta-sand/50 transition font-bold text-nesta-navy">‚úï</button>
            </div>
            <div id="saved-list" class="flex-1 overflow-y-auto p-8 bg-[#F9FAFB] grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-nesta-navy text-white px-6 py-4 shadow-2xl transform translate-y-20 opacity-0 transition-all duration-500 z-[110] font-bold text-sm flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-nesta-green"></div><span id="toast-msg">Notification</span>
    </div>

    <script>
        // CONFIG & STATE
        const API_BASE_URL = window.location.origin;
        let currentSignals = [];
        let radarChart = null;
        let isProcessing = false;
        let currentSaved = [];

        // EMOJI MAPPINGS
        const MISSION_EMOJIS = {
            'A Fairer Start': 'üìö',
            'A Healthy Life': '‚ù§Ô∏è‚Äçü©π',
            'A Sustainable Future': 'üå≥'
        };
        const LENS_EMOJIS = {
            'Social': 'üë•',
            'Tech': 'ü§ñ',
            'Media': 'üéôÔ∏è',
            'Powerhouse': '‚ö°'
        };

        // INIT
        function initDashboard() { loadPreview(); }

        // UTILS
        function getMissionEmoji(mission) {
            for (const [key, emoji] of Object.entries(MISSION_EMOJIS)) {
                if (mission.includes(key)) return emoji;
            }
            return ''; 
        }

        function formatSource(url) {
            try {
                const hostname = new URL(url).hostname.replace('www.', '');
                const name = hostname.split('.')[0];
                return name.length <= 3 ? name.toUpperCase() : name.charAt(0).toUpperCase() + name.slice(1);
            } catch { return 'Source'; }
        }

        function getLensBadges(lensesStr) {
            if (!lensesStr) return '';
            const tags = lensesStr.split(',').map(t => t.trim());
            let html = '<div class="flex flex-wrap gap-1 mb-3">';
            tags.forEach(tag => {
                let emoji = '';
                for (const [key, icon] of Object.entries(LENS_EMOJIS)) {
                    if (tag.toLowerCase().includes(key.toLowerCase())) emoji = icon;
                }
                if (emoji) {
                    html += `<span class="px-2 py-0.5 border border-nesta-sand rounded text-[10px] text-nesta-darkgrey bg-nesta-sand/10" title="${tag}">${emoji} ${tag}</span>`;
                }
            });
            html += '</div>';
            return html;
        }

        async function loadPreview() {
            const grid = document.getElementById('preview-grid');
            try {
                const res = await fetch(`${API_BASE_URL}/api/saved`);
                const data = await res.json();
                if(!data || data.length === 0) { grid.innerHTML = '<div class="col-span-3 text-center py-10 text-nesta-darkgrey">No signals in database yet.</div>'; return; }
                const recent = data.slice(0, 3);
                grid.innerHTML = ''; 
                recent.forEach((sig, i) => {
                    const normalized = {
                        title: sig.Title, score: sig.Score, hook: sig.Hook, final_url: sig.URL,
                        mission: sig.Mission, lenses: sig.Lenses, // Pass Lenses
                        score_novelty: sig.Score_Novelty, score_evidence: sig.Score_Evidence, score_evocativeness: sig.Score_Evocativeness,
                        shareable: sig.Shareable, _row: sig._row, source_date: sig.Source_Date
                    };
                    createSignalCard(normalized, i, false, 'preview-grid');
                });
            } catch(e) { console.error(e); grid.innerHTML = '<div class="col-span-3 text-center text-xs text-nesta-red">Unable to load preview.</div>'; }
        }

        // UTILS
        function showToast(msg, type='success') {
            const el = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const dot = el.querySelector('div');
            dot.className = `w-2 h-2 rounded-full ${type === 'error' ? 'bg-nesta-red' : 'bg-nesta-green'}`;
            el.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => el.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function handleEnter(e) { if(e.key === 'Enter') generateSignal(false); }
        function getCheckedSources() { return Array.from(document.querySelectorAll('#source-bias-container input:checked')).map(cb => cb.value); }

        function switchView(view) {
            const list = document.getElementById('result-container');
            const radar = document.getElementById('radar-container');
            const btnList = document.getElementById('btn-list');
            const btnRadar = document.getElementById('btn-radar');
            if(view === 'list') {
                list.classList.remove('hidden'); radar.classList.add('hidden');
                btnList.className = "px-4 py-2 text-xs font-bold transition shadow-sm bg-white text-nesta-navy";
                btnRadar.className = "px-4 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy";
            } else {
                list.classList.add('hidden'); radar.classList.remove('hidden');
                btnRadar.className = "px-4 py-2 text-xs font-bold transition shadow-sm bg-white text-nesta-navy";
                btnList.className = "px-4 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy";
                renderRadar();
            }
        }

        // CORE LOGIC
        async function generateSignal(isBroad) {
            if (isProcessing) return;
            const topic = document.getElementById('topic-input').value;
            const container = document.getElementById('result-container');
            
            if (!topic && !isBroad) return showToast("Please enter a topic", "error");

            isProcessing = true;
            document.getElementById('search-btn').disabled = true;
            document.getElementById('btn-loader').classList.remove('hidden');
            
            container.innerHTML = `
                <div class="col-span-full py-20 flex flex-col items-center justify-center space-y-4">
                    <div class="w-16 h-16 border-4 border-nesta-sand border-t-nesta-blue rounded-full animate-spin"></div>
                    <p class="font-display text-xl text-nesta-navy animate-pulse">Running Deep Search & Verification...</p>
                </div>`;
            
            switchView('list');

            const payload = {
                message: isBroad 
                    ? `Find ${document.getElementById('signal-count').value} high-novelty weak signals related to ${document.getElementById('mission-select').value}. Context: ${topic}` 
                    : `Find ${document.getElementById('signal-count').value} signals about ${topic} for ${document.getElementById('mission-select').value}`,
                time_filter: document.getElementById('time-filter').value,
                source_types: getCheckedSources(),
                tech_mode: document.getElementById('tech-mode').checked
            };

            try {
                const res = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                const data = await res.json();
                container.innerHTML = '';

                if (data.ui_type === 'signal_list') {
                    currentSignals = data.items;
                    data.items.forEach((item, index) => {
                        setTimeout(() => createSignalCard(item, index), index * 150);
                    });
                    setTimeout(loadPreview, 2000);
                } else {
                    container.innerHTML = `<div class="p-8 bg-white border border-nesta-sand text-center text-nesta-navy">${data.content}</div>`;
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="p-6 bg-red-50 text-nesta-red text-center font-bold">Connection Error.</div>`;
            } finally {
                isProcessing = false;
                document.getElementById('search-btn').disabled = false;
                document.getElementById('btn-loader').classList.add('hidden');
            }
        }

        // RENDER CARD
        function createSignalCard(signal, index, isSavedView = false, containerId = 'result-container') {
            const container = document.getElementById(containerId);
            
            // Mission Colour Logic
            let barColor = "bg-nesta-darkgrey"; 
            let badgeColor = "bg-gray-100 text-nesta-darkgrey";
            const m = (signal.mission || "").toLowerCase();
            
            if (m.includes("fairer")) { barColor = "bg-nesta-aqua"; badgeColor = "bg-nesta-aqua/20 text-nesta-navy"; }
            else if (m.includes("sustainable")) { barColor = "bg-nesta-green"; badgeColor = "bg-nesta-green/10 text-nesta-green"; }
            else if (m.includes("healthy")) { barColor = "bg-nesta-purple"; badgeColor = "bg-nesta-purple/10 text-nesta-purple"; }

            // Metadata Processing
            const missionEmoji = getMissionEmoji(signal.mission || '');
            const sourceName = formatSource(signal.final_url || signal.url);
            const lensTags = getLensBadges(signal.lenses || '');

            const card = document.createElement('div');
            card.className = `bg-white p-6 border-l border-r border-b border-nesta-sand border-t-8 ${barColor} card-hover flex flex-col h-full shadow-sm animate-fade-in-up`;
            card.style.borderTopColor = barColor.replace('bg-', 'var(--color-nesta-');

            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <span class="px-3 py-1 rounded-sm text-[10px] font-bold uppercase tracking-widest ${badgeColor}">
                        ${missionEmoji} ${signal.mission || 'General'}
                    </span>
                    <span class="flex items-center justify-center w-8 h-8 bg-nesta-black text-white font-bold text-sm shadow-md">${signal.score || '-'}</span>
                </div>
                <h3 class="text-2xl brand-font text-nesta-navy mb-3 leading-tight hover:text-nesta-blue transition-colors">
                    <a href="${signal.final_url || signal.url}" target="_blank" class="hover:underline decoration-2 underline-offset-2">${signal.title}</a>
                </h3>
                
                ${lensTags} <p class="text-sm text-nesta-darkgrey mb-6 leading-relaxed flex-grow font-body">${signal.hook}</p>
                <div class="grid grid-cols-3 gap-2 py-4 border-t border-b border-nesta-sand/30 mb-4">
                     <div class="text-center"><div class="text-[9px] text-nesta-darkgrey uppercase font-bold mb-1">Novelty</div><div class="font-bold text-nesta-navy text-lg">${signal.score_novelty}/10</div></div>
                     <div class="text-center border-l border-nesta-sand/30"><div class="text-[9px] text-nesta-darkgrey uppercase font-bold mb-1">Evidence</div><div class="font-bold text-nesta-navy text-lg">${signal.score_evidence}/10</div></div>
                     <div class="text-center border-l border-nesta-sand/30"><div class="text-[9px] text-nesta-darkgrey uppercase font-bold mb-1">Impact</div><div class="font-bold text-nesta-navy text-lg">${signal.score_evocativeness}/10</div></div>
                </div>
                <div class="flex items-center justify-between text-xs font-bold text-nesta-darkgrey mt-auto">
                    <span>${signal.source_date || 'Recent'}</span>
                    <a href="${signal.final_url || signal.url}" target="_blank" class="flex items-center gap-1 hover:text-nesta-blue transition">
                        ${sourceName} <span class="text-lg leading-none">‚Üó</span>
                    </a>
                </div>
                ${isSavedView ? `
                <div class="mt-4 pt-4 border-t border-nesta-sand space-y-3">
                    <div class="space-y-1">
                        <label class="text-[10px] uppercase font-bold text-nesta-darkgrey">Shareable Status</label>
                        <select id="saved-shareable-${index}" class="w-full text-xs bg-white border border-nesta-sand rounded-none px-2 py-2 font-bold text-nesta-navy focus:border-nesta-blue focus:ring-0">
                            <option value="Yes" ${signal.shareable === 'Yes' ? 'selected' : ''}>Yes - Shareable</option>
                            <option value="Maybe" ${signal.shareable === 'Maybe' ? 'selected' : ''}>Maybe</option>
                            <option value="No" ${signal.shareable === 'No' ? 'selected' : ''}>No - Reject</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                         <label class="text-[10px] uppercase font-bold text-nesta-darkgrey">Curator Notes</label>
                         <input type="text" id="saved-comment-${index}" class="w-full text-xs bg-white border border-nesta-sand px-2 py-2 text-nesta-navy focus:border-nesta-blue focus:ring-0" placeholder="Add comment..." value="${signal.feedback || ''}">
                    </div>
                    <button onclick="updateSavedSignal('${signal.final_url || signal.url}', '${(signal.title || "").replace(/'/g, "\\'")}', ${index})" class="w-full py-2 bg-nesta-navy text-white text-xs font-bold uppercase hover:bg-nesta-blue transition">Save Changes</button>
                </div>` : ''}
            `;
            container.appendChild(card);
        }

        async function openSavedSignals() {
            document.getElementById('saved-modal').classList.remove('hidden');
            const list = document.getElementById('saved-list');
            list.innerHTML = '<div class="col-span-full py-20 text-center"><div class="loader border-nesta-blue mx-auto mb-4"></div><p class="font-bold text-nesta-darkgrey">Loading Intelligence Database...</p></div>';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/saved`);
                const data = await res.json();
                list.innerHTML = '';
                currentSaved = data;
                if(data.length === 0) { list.innerHTML = '<div class="col-span-full text-center py-20 text-nesta-sand">Database is empty.</div>'; return; }
                data.forEach((sig, i) => {
                    const normalized = {
                        title: sig.Title, score: sig.Score, hook: sig.Hook, final_url: sig.URL,
                        mission: sig.Mission, lenses: sig.Lenses, // Ensure Lenses are passed
                        score_novelty: sig.Score_Novelty, score_evidence: sig.Score_Evidence, score_evocativeness: sig.Score_Evocativeness,
                        shareable: sig.Shareable, feedback: sig.Feedback || sig.User_Comment, _row: sig._row, source_date: sig.Source_Date
                    };
                    createSignalCard(normalized, i, true, 'saved-list');
                });
            } catch(e) { list.innerHTML = '<div class="col-span-full text-center text-nesta-red py-10 font-bold">Failed to load database.</div>'; }
        }

        function closeSavedSignals() { document.getElementById('saved-modal').classList.add('hidden'); }

        async function updateSavedSignal(url, title, domIndex) {
            const shareVal = document.getElementById(`saved-shareable-${domIndex}`).value;
            const commentVal = document.getElementById(`saved-comment-${domIndex}`)?.value || '';
            try {
                const res = await fetch(`${API_BASE_URL}/api/update`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url, title, shareable: shareVal, user_status: shareVal === 'No' ? 'Rejected' : 'Accepted', user_comment: commentVal, feedback: commentVal })
                });
                if(res.ok) { showToast('Database updated'); loadPreview(); }
                else throw new Error();
            } catch(e) { showToast('Update failed', 'error'); }
        }

        function downloadCSV() {
            if(!currentSaved || currentSaved.length === 0) return showToast('No data to export', 'error');
            let csv = "Title,URL,Score,Mission,Hook,Date,Status,Notes\n";
            currentSaved.forEach(r => { csv += `"${r.Title}","${r.URL}",${r.Score},"${r.Mission}","${(r.Hook||"").replace(/"/g, '""')}",${r.Source_Date},${r.Shareable},"${r.User_Comment||""}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Signal_Export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function renderRadar() {
            if(radarChart) radarChart.destroy();
            const ctx = document.getElementById('signalRadar').getContext('2d');
            const dataPoints = currentSignals.map(s => ({ x: s.score_novelty || Math.random()*10, y: s.score_evidence || Math.random()*10, r: (s.score/10)||5, title: s.title }));
            radarChart = new Chart(ctx, {
                type: 'bubble',
                data: { datasets: [{ label: 'Active Signals', data: dataPoints, backgroundColor: 'rgba(0, 0, 255, 0.6)', borderColor: '#0000FF', borderWidth: 1, hoverBackgroundColor: '#0F294A', hoverBorderColor: '#0F294A' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'NOVELTY (Distance from Mainstream)', font: { weight: 'bold', family: 'Averta' }, color: '#0F294A' }, min: 0, max: 10, grid: { color: '#D2C9C0' } }, y: { title: { display: true, text: 'EVIDENCE (Reality Factor)', font: { weight: 'bold', family: 'Averta' }, color: '#0F294A' }, min: 0, max: 10, grid: { color: '#D2C9C0' } } }, plugins: { tooltip: { backgroundColor: '#0F294A', titleFont: { family: 'Zosia Display', size: 14 }, bodyFont: { family: 'Averta' }, padding: 12, callbacks: { label: function(context) { return context.raw.title; } } }, legend: { display: false } } }
            });
        }
    </script>
</body>
</html>
