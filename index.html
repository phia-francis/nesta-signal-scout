<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nesta Signal Scout Pro</title>
    
    <script>
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nesta: {
                            blue: '#0000FF',       
                            navy: '#0F294A',       
                            pink: '#F6A4B7',       
                            yellow: '#FDB633',     
                            green: '#18A48C',      
                            aqua: '#97D9E3',       
                            purple: '#9A1BBE',     
                            orange: '#FF6E47',     
                            red: '#EB003B',        
                            sand: '#D2C9C0',       
                            darkgrey: '#646363',   
                            black: '#000000',      
                            white: '#FFFFFF'       
                        }
                    },
                    fontFamily: {
                        display: ['"Zosia Display"', 'sans-serif'],
                        body: ['"Averta"', 'sans-serif']
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'radar-spin': 'spin 2s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        pop: {
                            '0%': { transform: 'scale(0.95)' },
                            '100%': { transform: 'scale(1)' }
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.6' }
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(15, 41, 74, 0.08)',
                        'hover': '0 10px 25px -5px rgba(0, 0, 255, 0.12)',
                        'glow': '0 0 15px rgba(151, 217, 227, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        /* FONTS */
        @font-face { font-family: 'Zosia Display'; src: url('Zosia-Display.woff2') format('woff2'); font-weight: bold; font-style: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Regular.otf') format('opentype'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Semibold.otf') format('opentype'); font-weight: bold; font-style: normal; }

        body { font-family: 'Averta', sans-serif; background-color: #F9FAFB; color: #0F294A; }
        h1, h2, h3, .brand-font { font-family: 'Zosia Display', sans-serif; }

        /* UTILITIES */
        .glass-panel { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(15, 41, 74, 0.05); }
        .card-hover { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 30px -8px rgba(0, 0, 255, 0.12); }
        
        /* HIGHLIGHT FOR RADAR CLICK */
        .card-highlight {
            border-color: #0000FF !important;
            box-shadow: 0 0 0 4px rgba(0, 0, 255, 0.2) !important;
            transform: scale(1.02);
        }
        
        /* CUSTOM RANGE SLIDER */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #0000FF; cursor: pointer; margin-top: -7px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #97D9E3; border-radius: 2px;
        }

        /* RADAR LOADER */
        .radar-loader {
            width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid rgba(151, 217, 227, 0.2);
            border-top-color: #97D9E3;
            animation: spin 1.2s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- BUTTON ANIMATIONS & INTERACTIVITY --- */
        
        /* Filter Chips (Purple) */
        .bias-chip label {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }
        .bias-chip label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(15, 41, 74, 0.1);
            border-color: #9A1BBE;
        }
        .bias-chip label:active { transform: scale(0.95); }
        .bias-chip input:checked + label {
            background-color: #9A1BBE; 
            color: #FFFFFF; 
            border-color: #9A1BBE; 
            box-shadow: 0 4px 12px rgba(154, 27, 190, 0.3);
            animation: pulse-purple 0.4s ease-out;
        }

        /* Hard Tech Toggle (Orange) */
        .tech-toggle-label { transition: all 0.2s ease; }
        .tech-toggle-group:hover .tech-toggle-label { color: #FF6E47; }
        .tech-toggle-group:active { transform: scale(0.98); }

        /* CTA Buttons */
        .btn-interactive { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-interactive:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn-interactive:active { transform: translateY(0); transform: scale(0.97); }

        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(154, 27, 190, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(154, 27, 190, 0); }
            100% { box-shadow: 0 0 0 0 rgba(154, 27, 190, 0); }
        }
        
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased bg-gray-50" onload="initDashboard()">

    <header class="bg-nesta-navy text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white text-nesta-navy flex items-center justify-center text-xl font-bold rounded-sm brand-font shadow-md">N</div>
                <div class="flex flex-col">
                    <h1 class="text-2xl leading-none tracking-tight">Signal Scout <span class="text-nesta-aqua">Pro</span></h1>
                    <span class="text-[10px] font-bold tracking-[0.2em] uppercase opacity-70">Discovery Hub</span>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="downloadCSV()" class="btn-interactive px-4 py-2 text-sm font-bold text-white hover:text-nesta-aqua flex items-center gap-2 group border border-transparent hover:border-white/10 rounded">
                    <svg class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Export
                </button>
                <button onclick="openSavedSignals()" class="btn-interactive px-6 py-2 bg-white text-nesta-navy text-sm font-bold rounded-sm hover:bg-nesta-aqua hover:text-nesta-navy shadow-lg">
                    Full Database
                </button>
            </div>
        </div>
        <div class="h-1.5 w-full bg-gradient-to-r from-nesta-blue via-nesta-purple to-nesta-orange"></div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-6 py-10 space-y-10">
        
        <div class="bg-white rounded-xl shadow-soft p-10 space-y-10 relative overflow-hidden border border-gray-100">
            
            <div class="relative group">
                <label for="topic-input" class="sr-only">Search</label>
                <input type="text" id="topic-input" name="topic"
                    class="w-full text-4xl font-display text-nesta-navy placeholder-gray-300 border-b-2 border-nesta-sand py-4 focus:outline-none focus:border-nesta-aqua transition-all bg-transparent"
                    placeholder="Scanning for... (e.g. 'Synthetic Biology')"
                    onkeypress="handleEnter(event)">
                <div class="absolute right-0 top-6 text-nesta-blue transition-transform group-focus-within:scale-110 duration-300">
                    <svg class="w-10 h-10 animate-pulse-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-10 items-end">
                
                <div class="md:col-span-4 space-y-3">
                    <label for="mission-select" class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Nesta Mission</label>
                    <div class="relative">
                        <select id="mission-select" name="mission" class="w-full appearance-none bg-gray-50/50 border-b-2 border-nesta-sand text-nesta-navy font-bold py-3 px-4 rounded-t-sm focus:ring-0 focus:border-nesta-aqua cursor-pointer hover:bg-gray-50 transition">
                            <option class="text-nesta-navy" value="All Missions">All Missions</option>
                            <option class="text-nesta-navy" value="A Fairer Start">A Fairer Start üìö</option>
                            <option class="text-nesta-navy" value="A Healthy Life">A Healthy Life ‚ù§Ô∏è‚Äçü©π</option>
                            <option class="text-nesta-navy" value="A Sustainable Future">A Sustainable Future üå≥</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-nesta-navy">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-3 space-y-4">
                    <div class="flex justify-between items-baseline">
                        <label for="signal-count" class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Quantity</label>
                        <span id="count-display" class="text-xs font-bold text-nesta-navy bg-nesta-aqua/20 px-3 py-1 rounded-full">5 Signals</span>
                    </div>
                    <input type="range" id="signal-count" name="count" min="1" max="10" value="5" 
                           oninput="document.getElementById('count-display').innerText = this.value + ' Signals'"
                           class="w-full">
                </div>

                <div class="md:col-span-5 flex flex-wrap gap-4 justify-end">
                    <div class="flex items-center gap-3 bg-gray-50 px-5 py-3 border border-nesta-sand rounded-lg cursor-pointer hover:border-nesta-orange/50 transition shadow-sm tech-toggle-group">
                        <input type="checkbox" id="tech-mode" name="tech_mode" class="w-5 h-5 text-nesta-orange border-gray-300 rounded focus:ring-nesta-orange bg-white checked:bg-nesta-orange checked:border-transparent cursor-pointer">
                        <label for="tech-mode" class="text-sm font-bold text-nesta-navy cursor-pointer select-none tech-toggle-label">Hard Tech Only</label>
                    </div>
                    
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchView('list')" id="btn-list" class="px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md hover:scale-105 active:scale-95">List</button>
                        <button onclick="switchView('radar')" id="btn-radar" class="px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md hover:scale-105 active:scale-95">Radar</button>
                    </div>
                </div>
            </div>

            <div class="pt-8 border-t border-gray-100 flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex flex-wrap gap-3" id="source-bias-container">
                    <div class="bias-chip relative"><input type="checkbox" id="bias-academia" name="source_bias" value="Academia" class="peer sr-only"><label for="bias-academia" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">Academia</label></div>
                    <div class="bias-chip relative"><input type="checkbox" id="bias-vc" name="source_bias" value="VC" class="peer sr-only"><label for="bias-vc" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">VC Blogs</label></div>
                    <div class="bias-chip relative"><input type="checkbox" id="bias-scimags" name="source_bias" value="Scientific Magazines" class="peer sr-only"><label for="bias-scimags" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">Sci Mags</label></div>
                    <div class="bias-chip relative"><input type="checkbox" id="bias-niche" name="source_bias" value="Niche Forums" class="peer sr-only"><label for="bias-niche" class="px-4 py-2 border border-nesta-sand rounded-full text-xs font-bold text-nesta-darkgrey cursor-pointer block">Niche Forums</label></div>
                </div>
                
                <div class="flex gap-4 w-full md:w-auto items-center">
                    <label for="time-filter" class="sr-only">Time Horizon</label>
                    <select id="time-filter" name="time_filter" class="bg-transparent text-sm font-bold text-nesta-navy focus:outline-none hover:text-nesta-blue cursor-pointer px-2">
                        <option class="text-nesta-navy">Past Month</option>
                        <option class="text-nesta-navy">Past 3 Months</option>
                        <option class="text-nesta-navy">Past 6 Months</option>
                        <option class="text-nesta-navy">Past Year</option>
                    </select>
                    <div class="h-6 w-px bg-gray-300"></div>
                    
                    <button onclick="generateSignal(true)" id="broad-btn" class="btn-interactive px-6 py-3 text-sm font-bold text-nesta-darkgrey hover:text-nesta-blue hover:bg-gray-50 rounded border border-transparent hover:border-nesta-blue/20">Broad Scan</button>
                    
                    <button id="search-btn" onclick="generateSignal(false)" class="btn-interactive px-8 py-3 bg-nesta-blue text-white text-sm font-bold rounded shadow-lg hover:bg-blue-700 hover:shadow-xl flex items-center gap-3">
                        <span>Initiate Scan</span>
                    </button>
                    
                    <button id="stop-btn" onclick="stopScan()" class="hidden btn-interactive px-8 py-3 bg-nesta-red text-white text-sm font-bold rounded shadow-lg hover:bg-red-700 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        Stop
                    </button>
                </div>
            </div>
        </div>

        <div id="result-container" class="grid grid-cols-1 gap-8"></div>
        
        <div id="radar-container" class="hidden bg-white p-10 shadow-soft border border-gray-100 min-h-[600px] flex flex-col items-center justify-center rounded-xl">
            <h3 class="text-2xl brand-font mb-8 text-nesta-navy">Innovation Landscape</h3>
            <p class="text-xs text-gray-400 mb-4 uppercase tracking-widest">Click dots to view signal</p>
            <div class="w-full h-[500px] relative"><canvas id="signalRadar"></canvas></div>
        </div>

        <section id="preview-section" class="pt-12 border-t border-gray-200">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-2xl brand-font text-nesta-navy">Recent Discoveries</h2>
                    <p class="text-sm text-nesta-darkgrey mt-1">Live updates from the shared database.</p>
                </div>
                <button onclick="openSavedSignals()" class="text-sm font-bold text-nesta-blue hover:text-nesta-navy transition flex items-center gap-1 group">
                    View All <span class="group-hover:translate-x-1 transition-transform">‚Üí</span>
                </button>
            </div>
            
            <div id="preview-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8 opacity-100">
                <div class="h-64 bg-white rounded-xl border border-gray-100 shadow-sm p-6 space-y-4 animate-pulse">
                    <div class="h-4 bg-gray-100 rounded w-1/3"></div>
                    <div class="h-6 bg-gray-100 rounded w-3/4"></div>
                    <div class="h-20 bg-gray-100 rounded"></div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-nesta-navy text-white mt-auto">
        <div class="h-1 w-full bg-gradient-to-r from-nesta-blue via-nesta-purple to-nesta-orange"></div>
        <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-6 h-6 bg-white text-nesta-navy flex items-center justify-center text-sm font-bold rounded-sm brand-font">N</div>
                <div class="flex flex-col">
                    <span class="text-sm font-display leading-none">Nesta Discovery Hub</span>
                </div>
            </div>
            <div class="text-[10px] font-body opacity-50 tracking-wide">
                &copy; 2025 NESTA. ALL RIGHTS RESERVED.
            </div>
        </div>
    </footer>

    <div id="saved-modal" class="fixed inset-0 bg-nesta-navy/90 backdrop-blur-md z-[100] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-7xl h-[85vh] shadow-2xl flex flex-col overflow-hidden rounded-2xl animate-fade-in-up">
            <div class="px-10 py-6 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h2 class="text-3xl brand-font text-nesta-navy">Signal Database</h2>
                    <p class="text-xs text-nesta-blue font-bold uppercase tracking-wider mt-1">Manage & Curate</p>
                </div>
                <button onclick="closeSavedSignals()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 transition rounded-full text-nesta-navy font-bold text-xl">‚úï</button>
            </div>
            <div id="saved-list" class="flex-1 overflow-y-auto p-10 bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-nesta-navy text-white px-6 py-4 shadow-2xl transform translate-y-24 opacity-0 transition-all duration-500 z-[120] font-bold text-sm flex items-center gap-4 rounded-lg border-l-4 border-nesta-aqua">
        <div class="w-2 h-2 rounded-full bg-nesta-aqua shrink-0"></div><span id="toast-msg">Action Successful</span>
    </div>

    <script>
        const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://127.0.0.1:8000' 
            : 'https://nesta-signal-backend.onrender.com';

        let currentSignals = [];
        let radarChart = null;
        let isProcessing = false;
        let scanController = null; // For cancelling requests
        let currentSaved = [];

        const MISSION_EMOJIS = { 'A Fairer Start': 'üìö', 'A Healthy Life': '‚ù§Ô∏è‚Äçü©π', 'A Sustainable Future': 'üå≥' };
        const LENS_EMOJIS = { 'Social': 'üë•', 'Tech': 'ü§ñ', 'Media': 'üéôÔ∏è', 'Powerhouse': '‚ö°' };

        async function warmBackend() {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 5000);
            try {
                const res = await fetch(`${API_BASE_URL}/`, { method: 'GET', cache: 'no-store', signal: controller.signal });
                return res.ok;
            } catch (err) {
                console.error('Backend warmup failed', err);
                return false;
            } finally {
                clearTimeout(timeout);
            }
        }

        async function initDashboard() {
            const ready = await warmBackend();
            if (!ready) {
                showToast('Backend offline. Retrying...', 'error');
                setTimeout(loadPreview, 1500);
                return;
            }
            loadPreview();
        }

        function getMissionEmoji(mission) {
            for (const [key, emoji] of Object.entries(MISSION_EMOJIS)) { if (mission.includes(key)) return emoji; }
            return ''; 
        }

        function formatSource(url) {
            try {
                const hostname = new URL(url).hostname.replace('www.', '');
                const name = hostname.split('.')[0];
                return name.length <= 3 ? name.toUpperCase() : name.charAt(0).toUpperCase() + name.slice(1);
            } catch { return 'Source'; }
        }

        function cleanText(text) {
            if (!text) return "";
            // Remove "In 2024," or "In 2025 " at the start
            let clean = text.replace(/^In \d{4},?\s*/i, "");
            // Drop bracketed citations (e.g. "[1]") and stray backslashes
            clean = clean.replace(/\[[^\]]*\]/g, "").replace(/\\/g, "");
            return clean;
        }

        function getLensBadges(lensesStr) {
            if (!lensesStr) return '';
            const tags = lensesStr.split(',').map(t => t.trim());
            let html = '<div class="flex flex-wrap gap-2 mb-4">';
            tags.forEach(tag => {
                let emoji = '';
                for (const [key, icon] of Object.entries(LENS_EMOJIS)) {
                    if (tag.toLowerCase().includes(key.toLowerCase())) emoji = icon;
                }
                if (emoji) {
                    html += `<span class="px-2 py-1 border border-gray-200 rounded text-[10px] font-bold text-nesta-darkgrey bg-gray-50" title="${tag}">${emoji} ${tag}</span>`;
                }
            });
            html += '</div>';
            return html;
        }

        async function loadPreview() {
            const grid = document.getElementById('preview-grid');
            try {
                const res = await fetch(`${API_BASE_URL}/api/saved`);
                if(!res.ok) throw new Error();
                const data = await res.json();
                if(!data || data.length === 0) { grid.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-400">Database empty.</div>'; return; }
                const recent = data.slice(0, 3);
                grid.innerHTML = ''; 
                recent.forEach((sig, i) => {
                    const normalized = {
                        title: sig.Title, score: sig.Score, hook: sig.Hook, final_url: sig.URL,
                        mission: sig.Mission, lenses: sig.Lenses, 
                        score_novelty: sig.Score_Novelty, score_evidence: sig.Score_Evidence, score_evocativeness: sig.Score_Evocativeness,
                        shareable: sig.Shareable, _row: sig._row, source_date: sig.Source_Date
                    };
                    createSignalCard(normalized, i, false, 'preview-grid');
                });
            } catch(e) { grid.innerHTML = '<div class="col-span-3 text-center text-xs text-red-400 py-10">Database Offline</div>'; }
        }

        function showToast(msg, type='success') {
            const el = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const dot = el.querySelector('div');
            dot.className = `w-2 h-2 rounded-full ${type === 'error' ? 'bg-nesta-red' : 'bg-nesta-aqua'}`;
            el.className = `fixed bottom-8 right-8 bg-nesta-navy text-white px-6 py-4 shadow-2xl transform transition-all duration-500 z-[120] font-bold text-sm flex items-center gap-4 rounded-lg border-l-4 ${type === 'error' ? 'border-nesta-red' : 'border-nesta-aqua'}`;
            el.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => el.classList.add('translate-y-24', 'opacity-0'), 3000);
        }

        function handleEnter(e) { if(e.key === 'Enter') generateSignal(false); }
        function getCheckedSources() { return Array.from(document.querySelectorAll('#source-bias-container input:checked')).map(cb => cb.value); }

        function switchView(view) {
            const list = document.getElementById('result-container');
            const radar = document.getElementById('radar-container');
            const btnList = document.getElementById('btn-list');
            const btnRadar = document.getElementById('btn-radar');
            if(view === 'list') {
                list.classList.remove('hidden'); radar.classList.add('hidden');
                btnList.className = "px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md";
                btnRadar.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
            } else {
                list.classList.add('hidden'); radar.classList.remove('hidden');
                btnRadar.className = "px-5 py-2 text-xs font-bold transition shadow-sm bg-nesta-navy text-white rounded-md";
                btnList.className = "px-5 py-2 text-xs font-bold transition text-nesta-darkgrey hover:text-nesta-navy rounded-md";
                renderRadar();
            }
        }

        function setScanningState(isScanning) {
            const startBtn = document.getElementById('search-btn');
            const broadBtn = document.getElementById('broad-btn');
            const stopBtn = document.getElementById('stop-btn');

            if (isScanning) {
                // HIDE Start buttons, SHOW Stop button
                startBtn.classList.add('hidden');
                broadBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
            } else {
                // SHOW Start buttons, HIDE Stop button
                startBtn.classList.remove('hidden');
                broadBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            }
        }

        function stopScan() {
            if (scanController) {
                scanController.abort();
                scanController = null;
                showToast('Scan Cancelled', 'error');
                // The finally block in generateSignal will handle UI reset via setScanningState(false)
            }
        }

        async function generateSignal(isBroad) {
            if (isProcessing) return;
            const topic = document.getElementById('topic-input').value;
            const container = document.getElementById('result-container');
            
            if (!topic && !isBroad) return showToast("Please enter a topic", "error");

            // UI UPDATES START
            isProcessing = true;
            setScanningState(true); // Toggle buttons
            
            container.innerHTML = `
                <div class="col-span-full py-24 flex flex-col items-center justify-center space-y-6 animate-fade-in-up">
                    <div class="radar-loader"></div>
                    <div class="text-center">
                        <p class="font-display text-2xl text-nesta-navy mb-1">Scanning Horizon...</p>
                        <p class="text-xs font-bold text-nesta-darkgrey uppercase tracking-widest">Searching ‚Ä¢ Scraping ‚Ä¢ Scoring</p>
                    </div>
                </div>`;
            
            switchView('list');

            const payload = {
                message: isBroad 
                    ? `Find ${document.getElementById('signal-count').value} high-novelty weak signals related to ${document.getElementById('mission-select').value}. Context: ${topic}` 
                    : `Find ${document.getElementById('signal-count').value} signals about ${topic} for ${document.getElementById('mission-select').value}`,
                time_filter: document.getElementById('time-filter').value,
                source_types: getCheckedSources(),
                tech_mode: document.getElementById('tech-mode').checked
            };

            // INIT CONTROLLER
            scanController = new AbortController();
            const signal = scanController.signal;

            try {
                const backendReady = await warmBackend();
                if (!backendReady) {
                    container.innerHTML = `<div class="p-8 bg-white border-l-4 border-nesta-red shadow-sm text-center"><p class="font-bold text-nesta-red">Backend Offline</p><p class="text-sm text-gray-500">Could not reach the scanning service. Trying again in a moment...</p></div>`;
                    showToast('Could not reach backend. Please retry.', 'error');
                    return;
                }

                const res = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                    signal: signal // Attach signal
                });
                
                if(!res.ok) throw new Error();
                const data = await res.json();
                container.innerHTML = '';

                if (data.ui_type === 'signal_list') {
                    currentSignals = data.items;
                    data.items.forEach((item, index) => {
                        setTimeout(() => createSignalCard(item, index), index * 100);
                    });
                    setTimeout(loadPreview, 2000);
                } else {
                    container.innerHTML = `<div class="p-10 bg-white border border-gray-100 rounded-xl text-center text-nesta-navy shadow-sm">${data.content}</div>`;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    container.innerHTML = `<div class="p-10 text-center text-gray-400">Scan cancelled.</div>`;
                } else {
                    container.innerHTML = `<div class="p-8 bg-white border-l-4 border-nesta-red shadow-sm text-center"><p class="font-bold text-nesta-red">Connection Failed</p><p class="text-sm text-gray-500">Please check your internet or try again later.</p></div>`;
                }
            } finally {
                // UI UPDATES END
                isProcessing = false;
                scanController = null;
                setScanningState(false); // Reset buttons
            }
        }

        function createSignalCard(signal, index, isSavedView = false, containerId = 'result-container') {
            const container = document.getElementById(containerId);
            
            // MISSION COLOUR LOGIC
            let barColor = "bg-nesta-darkgrey"; 
            let badgeColor = "bg-gray-100 text-nesta-darkgrey";
            const m = (signal.mission || "").toLowerCase();
            
            if (m.includes("fairer")) { 
                barColor = "bg-nesta-yellow"; 
                badgeColor = "bg-nesta-yellow text-nesta-navy"; 
            }
            else if (m.includes("sustainable")) { 
                barColor = "bg-nesta-green"; 
                badgeColor = "bg-nesta-green text-nesta-navy"; 
            }
            else if (m.includes("healthy")) { 
                barColor = "bg-nesta-pink"; 
                badgeColor = "bg-nesta-pink text-nesta-navy"; 
            }

            const missionEmoji = getMissionEmoji(signal.mission || '');
            const sourceName = formatSource(signal.final_url || signal.url);
            const lensTags = getLensBadges(signal.lenses || '');
            const cleanHook = cleanText(signal.hook);

            const card = document.createElement('div');
            // Add ID for scroll targeting
            card.id = `${containerId}-card-${index}`;
            card.className = `bg-white p-7 border border-gray-100 border-t-8 ${barColor} card-hover flex flex-col h-full shadow-soft rounded-xl animate-fade-in-up transition-all duration-300`;
            card.style.borderTopColor = barColor.replace('bg-', 'var(--color-nesta-');

            card.innerHTML = `
                <div class="flex justify-between items-start mb-5">
                    <span class="px-3 py-1 rounded-sm text-[10px] font-bold uppercase tracking-widest ${badgeColor}">
                        ${missionEmoji} ${signal.mission || 'General'}
                    </span>
                    <span class="flex items-center justify-center w-8 h-8 bg-nesta-black text-white font-bold text-sm rounded-full shadow-md">
                        ${signal.score || '-'}
                    </span>
                </div>
                
                <h3 class="text-2xl brand-font text-nesta-navy mb-3 leading-tight hover:text-nesta-blue transition-colors">
                    <a href="${signal.final_url || signal.url}" target="_blank" class="hover:underline decoration-2 underline-offset-4 decoration-nesta-blue/30">${signal.title}</a>
                </h3>
                
                ${lensTags}

                <p class="text-sm text-nesta-darkgrey mb-6 leading-relaxed flex-grow font-body">${cleanHook}</p>
                
                <div class="grid grid-cols-3 gap-2 py-4 border-t border-b border-gray-100 mb-5 bg-gray-50/50 rounded-sm">
                     <div class="text-center"><div class="text-[9px] text-gray-400 uppercase font-bold mb-1 tracking-wider">Novelty</div><div class="font-bold text-nesta-navy text-lg">${signal.score_novelty}/10</div></div>
                     <div class="text-center border-l border-gray-200"><div class="text-[9px] text-gray-400 uppercase font-bold mb-1 tracking-wider">Evidence</div><div class="font-bold text-nesta-navy text-lg">${signal.score_evidence}/10</div></div>
                     <div class="text-center border-l border-gray-200"><div class="text-[9px] text-gray-400 uppercase font-bold mb-1 tracking-wider">Impact</div><div class="font-bold text-nesta-navy text-lg">${signal.score_evocativeness}/10</div></div>
                </div>
                
                <div class="flex items-center justify-between text-xs font-bold text-gray-400 mt-auto">
                    <span>${signal.source_date || 'Recent'}</span>
                    <a href="${signal.final_url || signal.url}" target="_blank" class="flex items-center gap-1 hover:text-nesta-blue transition group">
                        ${sourceName} <span class="text-lg leading-none group-hover:translate-x-0.5 transition-transform">‚Üó</span>
                    </a>
                </div>

                ${isSavedView ? `
                <div class="mt-5 pt-5 border-t border-gray-100 space-y-4">
                    <div class="space-y-1">
                        <label for="saved-shareable-${index}" class="text-[10px] uppercase font-bold text-gray-400">Status</label>
                        <select id="saved-shareable-${index}" class="w-full text-xs bg-gray-50 border border-gray-200 rounded px-3 py-2 font-bold text-nesta-navy focus:border-nesta-blue focus:ring-0">
                            <option value="Yes" ${signal.shareable === 'Yes' ? 'selected' : ''}>Yes - Shareable</option>
                            <option value="Maybe" ${signal.shareable === 'Maybe' ? 'selected' : ''}>Maybe</option>
                            <option value="No" ${signal.shareable === 'No' ? 'selected' : ''}>No - Reject</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                         <label for="saved-comment-${index}" class="text-[10px] uppercase font-bold text-gray-400">Notes</label>
                         <input type="text" id="saved-comment-${index}" class="w-full text-xs bg-gray-50 border border-gray-200 px-3 py-2 text-nesta-navy focus:border-nesta-blue focus:ring-0 rounded" placeholder="Add comment..." value="${signal.feedback || ''}">
                    </div>
                    <button onclick="updateSavedSignal('${signal.final_url || signal.url}', '${(signal.title || "").replace(/'/g, "\\'")}', ${index})" class="w-full py-2.5 bg-nesta-navy text-white text-xs font-bold uppercase rounded hover:bg-nesta-blue transition shadow-md">Save Changes</button>
                </div>` : ''}
            `;
            container.appendChild(card);
        }

        async function openSavedSignals() {
            document.getElementById('saved-modal').classList.remove('hidden');
            const list = document.getElementById('saved-list');
            list.innerHTML = '<div class="col-span-full py-24 text-center flex flex-col items-center"><div class="radar-loader mb-4"></div><p class="font-bold text-nesta-navy">Retrieving Intelligence...</p></div>';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/saved`);
                const data = await res.json();
                list.innerHTML = '';
                currentSaved = data;
                if(data.length === 0) { list.innerHTML = '<div class="col-span-full text-center py-20 text-gray-400">Database is empty.</div>'; return; }
                data.forEach((sig, i) => {
                    const normalized = {
                        title: sig.Title, score: sig.Score, hook: sig.Hook, final_url: sig.URL,
                        mission: sig.Mission, lenses: sig.Lenses, 
                        score_novelty: sig.Score_Novelty, score_evidence: sig.Score_Evidence, score_evocativeness: sig.Score_Evocativeness,
                        shareable: sig.Shareable, feedback: sig.Feedback || sig.User_Comment, _row: sig._row, source_date: sig.Source_Date
                    };
                    createSignalCard(normalized, i, true, 'saved-list');
                });
            } catch(e) { list.innerHTML = '<div class="col-span-full text-center text-nesta-red py-10 font-bold">Failed to load database.</div>'; }
        }

        function closeSavedSignals() { document.getElementById('saved-modal').classList.add('hidden'); }

        async function updateSavedSignal(url, title, domIndex) {
            const shareVal = document.getElementById(`saved-shareable-${domIndex}`).value;
            const commentVal = document.getElementById(`saved-comment-${domIndex}`)?.value || '';
            try {
                const res = await fetch(`${API_BASE_URL}/api/update`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url, title, shareable: shareVal, user_status: shareVal === 'No' ? 'Rejected' : 'Accepted', user_comment: commentVal, feedback: commentVal })
                });
                if(res.ok) { showToast('Database updated'); loadPreview(); }
                else throw new Error();
            } catch(e) { showToast('Update failed', 'error'); }
        }

        function downloadCSV() {
            if(!currentSaved || currentSaved.length === 0) return showToast('No data to export', 'error');
            let csv = "Title,URL,Score,Mission,Hook,Date,Status,Notes\n";
            currentSaved.forEach(r => { csv += `"${r.Title}","${r.URL}",${r.Score},"${r.Mission}","${(r.Hook||"").replace(/"/g, '""')}",${r.Source_Date},${r.Shareable},"${r.User_Comment||""}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Signal_Export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // --- INTERACTIVE RADAR ---
        function scrollToCard(index) {
            switchView('list'); // Switch back to list to see the card
            const cardId = `result-container-card-${index}`;
            const card = document.getElementById(cardId);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Visual feedback
                card.classList.add('card-highlight');
                setTimeout(() => card.classList.remove('card-highlight'), 2000);
            }
        }

        function renderRadar() {
            if(radarChart) radarChart.destroy();
            const ctx = document.getElementById('signalRadar').getContext('2d');
            const dataPoints = currentSignals.map((s, i) => ({ 
                x: s.score_novelty || Math.random()*10, 
                y: s.score_evidence || Math.random()*10, 
                r: (s.score/10)||5, 
                title: s.title,
                index: i // Store index for click handler
            }));
            
            radarChart = new Chart(ctx, {
                type: 'bubble',
                data: { datasets: [{ 
                    label: 'Active Signals', 
                    data: dataPoints, 
                    backgroundColor: 'rgba(0, 0, 255, 0.6)', 
                    borderColor: '#0000FF', 
                    borderWidth: 1, 
                    hoverBackgroundColor: '#0F294A', 
                    hoverBorderColor: '#0F294A' 
                }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const dataIndex = activeElements[0].index; // Index in dataset
                            const point = dataPoints[dataIndex];
                            scrollToCard(point.index);
                        }
                    },
                    scales: { 
                        x: { title: { display: true, text: 'NOVELTY (Distance from Mainstream)', font: { weight: 'bold', family: 'Averta' }, color: '#0F294A' }, min: 0, max: 10, grid: { color: '#E5E7EB' } }, 
                        y: { title: { display: true, text: 'EVIDENCE (Reality Factor)', font: { weight: 'bold', family: 'Averta' }, color: '#0F294A' }, min: 0, max: 10, grid: { color: '#E5E7EB' } } 
                    }, 
                    plugins: { 
                        tooltip: { backgroundColor: '#0F294A', titleFont: { family: 'Zosia Display', size: 14 }, bodyFont: { family: 'Averta' }, padding: 12, callbacks: { label: function(context) { return context.raw.title; } } }, 
                        legend: { display: false } 
                    } 
                }
            });
        }
    </script>
</body>
</html>
