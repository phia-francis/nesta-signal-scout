<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nesta Signal Scout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nesta: {
                            blue: '#0000FF', teal: '#00C3E8', red: '#F06432',
                            green: '#00E34D', purple: '#9055FF', dark: '#0F294A',
                            black: '#000000', white: '#FFFFFF', grey: '#F2F2F2'
                        }
                    },
                    fontFamily: { display: ['Zosia Display', 'sans-serif'], body: ['Averta', 'sans-serif'] },
                    animation: { 'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards' },
                    keyframes: { fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } },
                    boxShadow: { 'soft': '0 4px 20px rgba(0, 0, 0, 0.05)', 'hover': '0 10px 25px rgba(0, 0, 255, 0.1)' }
                }
            }
        }
    </script>
    <style>
        @font-face { font-family: 'Zosia Display'; src: url('Zosia-Display.woff2') format('woff2'); font-weight: bold; }
        @font-face { font-family: 'Averta'; src: url('Averta-Regular.otf') format('opentype'); font-weight: normal; }
        @font-face { font-family: 'Averta'; src: url('Averta-Semibold.otf') format('opentype'); font-weight: 600; }
        body { background-color: #FAFAFA; }
        .toggle-checkbox:checked { right: 0; border-color: #0000FF; }
        .toggle-checkbox:checked + .toggle-label { background-color: #0000FF; }
        .source-tag { border: 1px solid #E5E7EB; cursor: pointer; transition: all 0.2s; }
        .source-tag.active { background-color: #00C3E8; border-color: #00C3E8; font-weight: 600; color: black; }
        .preview-scroll { max-height: 150px; overflow-y: auto; scrollbar-width: thin; }

        /* Tooltip & Toast */
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #0F294A; color: white; padding: 8px; border-radius: 6px; font-size: 10px; white-space: nowrap; z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
        .tooltip-arrow { position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #0F294A transparent transparent transparent; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #0F294A; color: white; padding: 12px 24px; border-radius: 8px; font-family: 'Averta', sans-serif; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; display: flex; items-center; gap: 8px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="text-nesta-black font-body antialiased min-h-screen flex flex-col" onload="loadRecentSignals()">

    <div id="toast-container"></div>

    <header class="bg-nesta-dark text-white pt-8 pb-32 relative overflow-hidden shadow-lg">
        <div class="absolute top-0 right-0 w-96 h-96 bg-nesta-blue rounded-full mix-blend-multiply filter blur-3xl opacity-20 transform translate-x-1/2 -translate-y-1/2"></div>
        <div class="container mx-auto px-6 relative z-10">
            <div class="flex flex-col md:flex-row justify-between items-start mb-8 gap-6">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="h-10 w-10 bg-white rounded-full flex items-center justify-center text-nesta-blue font-display font-bold text-xl">N</div>
                        <span class="font-display text-xl tracking-wide">Discovery Hub</span>
                    </div>
                    <h1 class="font-display text-5xl font-bold tracking-tight">Signal Scout</h1>
                    <p class="text-nesta-teal font-body text-sm font-semibold tracking-wide uppercase mt-1">Automated Horizon Scanning</p>
                </div>
                <div class="w-full md:w-80 bg-white/5 rounded-xl p-4 border border-white/10 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold uppercase text-nesta-teal tracking-widest">Recent Saves</h3>
                        <button onclick="openSavedSignals()" class="text-[10px] font-bold uppercase tracking-widest bg-white text-nesta-dark px-3 py-1 rounded-full hover:bg-nesta-teal transition-colors">View All &rarr;</button>
                    </div>
                    <div id="preview-area" class="preview-scroll space-y-2"><div class="text-[10px] text-gray-400 italic">Loading...</div></div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-soft max-w-5xl mx-auto transform translate-y-8 border-b-4 border-nesta-blue text-nesta-black">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="topic-input" placeholder="Topic (Leave empty for random scan...)" class="flex-1 p-4 bg-gray-50 rounded-xl border-2 border-transparent focus:border-nesta-blue focus:bg-white focus:outline-none text-lg text-nesta-dark placeholder-gray-400 font-body transition-all" onkeydown="if(event.key === 'Enter') runScan()">
                    <button onclick="runScan()" class="bg-nesta-blue hover:bg-nesta-dark text-white font-display font-bold text-lg px-8 py-3 rounded-xl transition-all duration-300 hover:scale-105 shadow-lg whitespace-nowrap flex items-center gap-2"><span>ðŸš€ Scout</span></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center border-t border-gray-100 pt-6">
                    <div class="flex gap-4">
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">Count</label>
                            <select id="signal-count" class="bg-gray-100 text-sm font-bold p-2 rounded-lg border-none focus:ring-2 focus:ring-nesta-blue">
                                <option value="1">1 Signal</option>
                                <option value="3" selected>3 Signals</option>
                                <option value="5">5 Signals</option>
                                <option value="10">10 Signals</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">Horizon</label>
                            <select id="time-horizon" class="bg-gray-100 text-sm font-bold p-2 rounded-lg border-none focus:ring-2 focus:ring-nesta-blue">
                                <option value="Past Month">Past Month</option>
                                <option value="Past 3 Months">Past 3 Months</option>
                                <option value="Past Year">Past Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 justify-start md:justify-center">
                        <span class="text-xs font-bold uppercase text-gray-400 tracking-wider">Tech Mode</span>
                        <div class="relative inline-block w-10 align-middle">
                            <input type="checkbox" id="tech-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                            <label for="tech-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">Source Bias</label>
                        <div class="flex flex-wrap gap-2" id="source-filters">
                            <div class="source-tag text-[10px] font-bold px-2 py-1 rounded-md" onclick="toggleSource(this)" data-value="Academic">Academic</div>
                            <div class="source-tag text-[10px] font-bold px-2 py-1 rounded-md" onclick="toggleSource(this)" data-value="Trade Press">Trade</div>
                            <div class="source-tag text-[10px] font-bold px-2 py-1 rounded-md" onclick="toggleSource(this)" data-value="Niche Blogs">Blogs</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 pt-24 pb-12 flex-grow">
        <div id="status-area" class="mb-8 hidden text-center">
            <div class="inline-flex items-center gap-3 px-6 py-2 bg-white rounded-full shadow-sm border border-gray-100">
                <div class="w-2 h-2 bg-nesta-red rounded-full animate-ping"></div>
                <span class="font-bold text-nesta-dark text-sm" id="status-text">Agent Active...</span>
            </div>
        </div>

        <h2 class="font-display text-2xl font-bold text-nesta-dark mb-6 border-b border-gray-200 pb-2">New Signals</h2>
        <div id="results-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 min-h-[200px]">
            <div class="col-span-full text-center text-gray-400 italic py-10">Waiting for scan...</div>
        </div>
    </main>

    <div id="saved-modal" class="fixed inset-0 bg-nesta-dark bg-opacity-95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-6xl h-[90vh] flex flex-col shadow-2xl">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-3xl">
                <h2 class="font-display text-2xl font-bold text-nesta-dark">Signal Vault</h2>
                <button onclick="closeSavedSignals()" class="text-gray-400 hover:text-nesta-red font-bold text-2xl px-4">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
                <div id="saved-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </div>

    <footer class="bg-nesta-dark text-white pt-12 pb-8 border-t border-nesta-blue mt-auto">
        <div class="container mx-auto px-6 text-center text-xs text-gray-500">&copy; 2025 Nesta Discovery Hub.</div>
    </footer>

    <script>
        const API_BASE_URL = "https://nesta-signal-backend.onrender.com";
        const MISSION_COLORS = {
            'A Sustainable Future': 'text-nesta-green bg-green-50 border-nesta-green',
            'A Healthy Life': 'text-nesta-red bg-red-50 border-nesta-red',
            'A Fairer Start': 'text-nesta-purple bg-purple-50 border-nesta-purple',
            'General': 'text-nesta-blue bg-blue-50 border-nesta-blue'
        };

        function toggleSource(el) { el.classList.toggle('active'); }
        function getSelectedSources() { return Array.from(document.querySelectorAll('.source-tag.active')).map(t => t.getAttribute('data-value')); }

        function showToast(message, type='success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<div class="w-2 h-2 rounded-full ${type === 'success' ? 'bg-nesta-green' : 'bg-nesta-red'}"></div><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        async function loadRecentSignals() {
            const preview = document.getElementById('preview-area');
            try {
                const res = await fetch(`${API_BASE_URL}/api/saved`);
                const data = await res.json();
                preview.innerHTML = '';
                if(data.length > 0) {
                    data.slice(0, 5).forEach(sig => {
                        const div = document.createElement('div');
                        div.className = "p-2 bg-white/10 rounded hover:bg-white/20 transition cursor-pointer border border-white/5";
                        div.innerHTML = `<div class="font-bold text-white text-xs truncate">${sig.Title}</div><div class="text-[10px] text-nesta-teal">${sig.Mission || 'General'}</div>`;
                        div.onclick = openSavedSignals;
                        preview.appendChild(div);
                    });
                } else { preview.innerHTML = '<div class="text-[10px] text-gray-400">No signals found.</div>'; }
            } catch (e) { preview.innerHTML = '<div class="text-[10px] text-red-400">Error loading.</div>'; }
        }

        async function runScan() {
            const topic = document.getElementById('topic-input').value;
            const count = document.getElementById('signal-count').value;
            const horizon = document.getElementById('time-horizon').value;
            const tech = document.getElementById('tech-mode-toggle').checked;
            const sources = getSelectedSources();

            const container = document.getElementById('results-area');
            document.getElementById('status-area').classList.remove('hidden');
            document.getElementById('status-text').innerText = topic ? `Scouting: ${topic}...` : "Random scanning...";
            
            container.innerHTML = `<div class="col-span-full py-20 text-center"><div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-nesta-blue border-t-transparent mb-4"></div><p class="text-nesta-dark font-bold">Scanning...</p></div>`;

            try {
                const res = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: topic, time_filter: horizon, tech_mode: tech, source_types: sources, signal_count: parseInt(count) })
                });
                const data = await res.json();
                container.innerHTML = '';
                document.getElementById('status-area').classList.add('hidden');

                if (data.signals && data.signals.length > 0) {
                    data.signals.forEach((sig, i) => createSignalCard(sig, i, true, 'results-area'));
                } else {
                    container.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">No signals found. Try adjusting filters.</div>`;
                }
            } catch (e) { container.innerHTML = `<div class="col-span-full text-center text-red-500">Error.</div>`; }
        }

        function createSignalCard(signal, index, isNew, targetId) {
            const container = document.getElementById(targetId);
            const missionKey = signal.mission || 'General';
            const theme = MISSION_COLORS[missionKey] || MISSION_COLORS['General'];
            const accent = theme.split(' ')[0];
            const lenses = (signal.lenses || '').split(',').map(l => `<span class="bg-gray-100 text-[10px] px-2 py-1 rounded text-gray-500 uppercase tracking-wide">${l}</span>`).join('');
            
            const commentVal = signal.feedback || signal.user_comment || "";
            const shareableVal = signal.shareable || "Maybe";

            const html = `
                <div class="bg-white rounded-2xl p-6 shadow-soft hover:shadow-hover transition-all duration-300 border-t-4 ${theme.replace(/text-|bg-|border-/g, 'border-').split(' ').pop()} flex flex-col h-full animate-fade-in-up" style="animation-delay: ${index*100}ms">
                    
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400 border px-2 py-1 rounded">${signal.source_country || 'Global'}</span>
                        <div class="relative has-tooltip cursor-help group">
                            <span class="${accent} bg-gray-50 font-bold text-xs px-3 py-1 rounded-full border border-gray-100">${signal.score}/100</span>
                            <div class="tooltip">
                                <p>Novelty: <span class="text-nesta-teal">${signal.score_novelty}</span></p>
                                <p>Evidence: <span class="text-nesta-teal">${signal.score_evidence}</span></p>
                                <p>Evocative: <span class="text-nesta-teal">${signal.score_evocativeness}</span></p>
                                <div class="tooltip-arrow"></div>
                            </div>
                        </div>
                    </div>

                    <h3 class="font-display text-xl font-bold text-nesta-dark mb-3 leading-tight">${signal.title}</h3>
                    <p class="text-gray-600 text-sm leading-relaxed mb-4 flex-grow">${signal.hook}</p>
                    <div class="flex flex-wrap gap-1 mb-4">${lenses}</div>
                    
                    <div class="bg-gray-50 p-3 rounded-xl mb-4 border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[10px] font-bold uppercase text-gray-400">Feedback</label>
                            <select id="share-${index}-${targetId}" class="bg-white text-[10px] font-bold border border-gray-200 rounded px-2 py-1 focus:ring-1 focus:ring-nesta-blue">
                                <option value="Yes" ${shareableVal === 'Yes' ? 'selected' : ''}>Shareable: Yes</option>
                                <option value="Maybe" ${shareableVal === 'Maybe' ? 'selected' : ''}>Shareable: Maybe</option>
                                <option value="No" ${shareableVal === 'No' ? 'selected' : ''}>Shareable: No</option>
                            </select>
                        </div>
                        <textarea id="comment-${index}-${targetId}" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-xs outline-none resize-none focus:border-nesta-blue transition-colors" rows="2" placeholder="Add notes...">${commentVal}</textarea>
                    </div>

                    <div class="flex items-center justify-between mt-auto">
                        <a href="${signal.final_url}" target="_blank" class="text-gray-400 hover:text-nesta-blue text-xs font-bold uppercase flex items-center gap-1">Read <span>&rarr;</span></a>
                        <button onclick='saveSignal(this, ${JSON.stringify(signal).replace(/'/g, "&#39;")}, "${index}-${targetId}")' class="text-nesta-dark hover:text-white hover:bg-nesta-green transition-all border border-gray-200 hover:border-transparent font-bold text-xs px-3 py-2 rounded-lg flex items-center gap-1">
                            <span>${isNew ? 'Save Signal' : 'Update DB'}</span>
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function saveSignal(btn, signal, idSuffix) {
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span>Saving...</span>`;
            
            signal.feedback = document.getElementById(`comment-${idSuffix}`).value;
            signal.user_comment = signal.feedback; // Sync both fields
            signal.shareable = document.getElementById(`share-${idSuffix}`).value;

            fetch(`${API_BASE_URL}/api/save`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(signal)
            })
            .then(res => res.json())
            .then(data => {
                showToast(data.status === 'saved' ? 'Signal Saved to Vault' : 'Database Updated');
                btn.innerHTML = `<span>Success</span>`;
                btn.classList.add('bg-nesta-green', 'text-white', 'border-transparent');
                if(data.status === 'saved') loadRecentSignals();
                setTimeout(() => { 
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-nesta-green', 'text-white', 'border-transparent');
                }, 2000);
            })
            .catch(() => { showToast('Network Error', 'error'); btn.innerHTML = `<span>Retry</span>`; });
        }

        async function openSavedSignals() {
            document.getElementById('saved-modal').classList.remove('hidden');
            const list = document.getElementById('saved-list');
            list.innerHTML = '<div class="col-span-full text-center py-10">Loading database...</div>';
            try {
                const res = await fetch(`${API_BASE_URL}/api/saved`);
                const data = await res.json();
                list.innerHTML = '';
                data.forEach((sig, i) => {
                    const normalized = {
                        title: sig.Title, score: sig.Score, hook: sig.Hook, final_url: sig.URL,
                        source_country: sig.Source_Country, mission: sig.Mission, lenses: sig.Lenses,
                        feedback: sig.Feedback || sig.User_Comment, shareable: sig.Shareable,
                        score_novelty: sig.Score_Novelty, score_evidence: sig.Score_Evidence, score_evocativeness: sig.Score_Evocativeness
                    };
                    createSignalCard(normalized, i, false, 'saved-list');
                });
            } catch(e) { list.innerHTML = '<div class="col-span-full text-center text-red-500">Failed to load database.</div>'; }
        }

        function closeSavedSignals() { document.getElementById('saved-modal').classList.add('hidden'); }
    </script>
</body>
</html>
